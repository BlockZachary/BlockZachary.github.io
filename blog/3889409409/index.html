<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="referrer" content="no-referrer">

    <meta name="author" content="Zachary Block">


    <meta name="subtitle" content="这里是副标题">




<title>FastAPI | Zachary Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Zachary Blog" type="application/atom+xml">
</head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Zachary&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">归档</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Zachary&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">归档</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">FastAPI</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Zachary Block</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">2 月 3 日&nbsp;&nbsp;4:15:00</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/Python-Web/">Python Web</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="FastAPI"><a href="#FastAPI" class="headerlink" title="FastAPI"></a>FastAPI</h1><p>Fast API 是一个快速、高效、简单、标准化的 Web 框架</p>
<p>基于 Python3.8+进行使用</p>
<h1 id="Hello-FastAPI"><a href="#Hello-FastAPI" class="headerlink" title="Hello FastAPI"></a>Hello FastAPI</h1><p>接下来新建一个项目带领进入 FastAPI 的世界</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706970454931-c11af857-da68-4137-87d8-539c0b800330.png"></p>
<h2 id="依赖包安装"><a href="#依赖包安装" class="headerlink" title="依赖包安装"></a>依赖包安装</h2><ul>
<li><code>pip install fastapi[all]</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastapi[all]</span><br></pre></td></tr></table></figure>

<h2 id="实现-api"><a href="#实现-api" class="headerlink" title="实现 api"></a>实现 api</h2><p>创建一个<code>hellofastapi.py</code>文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>需要使用 fastapi 提供的一个<code>uvicorn</code>ASGI 网关服务器来启动 api 服务</p>
<ul>
<li><code>uvicorn hellofastapi:app --reload</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(venv) ➜  fastApiProject uvicorn hellofastapi:app --reload</span><br><span class="line">INFO:     Will watch for changes in these directories: [&#x27;/Users/zachary/Documents/PythonCode/fastApiProject&#x27;]</span><br><span class="line">INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)</span><br><span class="line">INFO:     Started reloader process [2378] using WatchFiles</span><br><span class="line">INFO:     Started server process [2382]</span><br><span class="line">INFO:     Waiting for application startup.</span><br><span class="line">INFO:     Application startup complete.</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706970974195-0c9136e7-ac32-4940-a477-e54641ee3b47.png"></p>
<p>直接在浏览器输入下方的地址：<code>http://127.0.0.1:8000</code></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706971032623-845ef2fe-ddc0-463d-96a8-aaff2436ee8d.png"></p>
<p>我们再额外加一个 api</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/hello/&#123;user&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">hello_user</span>(<span class="params">user</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Hello <span class="subst">&#123;user&#125;</span>&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706971153151-39f44a1a-93b2-484e-88cb-b71b071733d4.png"></p>
<h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p>直接在浏览器键入：<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/docs">http://127.0.0.1:8000/docs</a> 就有已经自动帮我们生成好的 swagger 文档</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706971248197-8d00ccf1-089e-4e04-9c80-46e9f56f0d15.png"></p>
<h2 id="快速运行"><a href="#快速运行" class="headerlink" title="快速运行"></a>快速运行</h2><p>当然也可以不使用命令行运行我们的 api 项目</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Hello World&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/hello/&#123;user&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">hello_user</span>(<span class="params">user</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Hello <span class="subst">&#123;user&#125;</span>&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;hellofastapi:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h1 id="路径参数"><a href="#路径参数" class="headerlink" title="路径参数"></a>路径参数</h1><h2 id="路径参数在-URL-中"><a href="#路径参数在-URL-中" class="headerlink" title="路径参数在 URL 中"></a>路径参数在 URL 中</h2><p>在 URL 中可以存在参数作为变量使用到程序中</p>
<p>重新建立一个目录<code>/path_params</code>在其中新建一个文件<code>main.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/user/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">user_id</span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: user_id,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706972329725-85b4b9a1-7e45-4db3-9aaf-06d6b0c2b80e.png"></p>
<h2 id="路径参数的校验"><a href="#路径参数的校验" class="headerlink" title="路径参数的校验"></a>路径参数的校验</h2><p>如果给路径参数指定类型，例如<code>int</code>，那么在进行 api 调用的时候 swagger 文档会自动帮我们进行一个校验</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/user/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">user_id: <span class="built_in">int</span></span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: user_id,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706972410901-8b66fe6b-e4c5-4a0f-966a-337189a9acb4.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706972437474-66f0b627-7eb5-4132-a5ff-4ddf1620d30e.png"></p>
<h2 id="api-定义的顺序"><a href="#api-定义的顺序" class="headerlink" title="api 定义的顺序"></a>api 定义的顺序</h2><p>假定我现在需要访问这么两个 api：<code>/users/current</code>和<code>/users/1</code></p>
<p>分别用于获取当前用户和 user_id 为 1 的用户</p>
<p>那么定义的时候顺序是很重要的</p>
<ul>
<li>第一种顺序</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">user_id: <span class="built_in">int</span></span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: user_id,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/current&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>():</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Jane Guilherme&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>访问<code>/users/current</code>会出问题</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706972898739-6091edca-4529-488d-9f37-aaa4fe98e743.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706972904110-2fa3a15b-3d2b-4592-9239-f61e24d1f1e8.png"></p>
<ul>
<li>第二种顺序</li>
</ul>
<p>需要调换一下 current 和 user_id 的定义顺序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/current&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>():</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Jane Guilherme&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">user_id: <span class="built_in">int</span></span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: user_id,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706973000885-071fc9dc-d439-411a-9f97-e1d32c8eee39.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706972985346-fe45f637-b1c5-43ad-88e2-d7622e988ed0.png"></p>
<p>这样都可以成功访问到</p>
<h2 id="枚举定义选择项"><a href="#枚举定义选择项" class="headerlink" title="枚举定义选择项"></a>枚举定义选择项</h2><p>目前在 swagger-UI 中的一些参数都是需要手动键入的</p>
<p>但有时候一些参数可能是一些固定选项，例如性别（男、女）这时候如果能实现选择项输入就更好了</p>
<p>使用枚举类实现选择项的定义</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Gender</span>(<span class="built_in">str</span>, Enum):</span><br><span class="line">    male = <span class="string">&quot;男性&quot;</span></span><br><span class="line">    female = <span class="string">&quot;女性&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/students/&#123;gender&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_student</span>(<span class="params">gender: Gender</span>):</span><br><span class="line">    student = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Tony Stark&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: gender</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;student&quot;</span>: student&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/current&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>():</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Jane Guilherme&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">user_id: <span class="built_in">int</span></span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: user_id,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1706974478510-4e7e030f-59c6-4fb6-adee-c4841ac236cb.png"></p>
<h1 id="查询参数"><a href="#查询参数" class="headerlink" title="查询参数"></a>查询参数</h1><p>什么是查询参数，类似于<code>http://127.0.0.1:8000/users?page_index=1&amp;page_size=10</code></p>
<p>其中的 page_index 和 page_size 都是查询参数</p>
<p>来个实例看看怎么做，先创建一个<code>/query_params</code>目录，然后目录下面创建<code>main.py</code></p>
<h2 id="查询参数在方法参数中"><a href="#查询参数在方法参数中" class="headerlink" title="查询参数在方法参数中"></a>查询参数在方法参数中</h2><ul>
<li>在注解处 就可以不用声明这两个查询参数了</li>
<li>直接在方法的参数中声明</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>(<span class="params">page_index: <span class="built_in">int</span>, page_size: <span class="built_in">int</span></span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Jane Guilherme&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    page_info = &#123;</span><br><span class="line">        <span class="string">&quot;page_index&quot;</span>: page_index,</span><br><span class="line">        <span class="string">&quot;page_size&quot;</span>: page_size</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user, <span class="string">&quot;page_info&quot;</span>: page_info&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>运行代码后直接在浏览器键入：<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/users?page_index=2&page_size=10">http://127.0.0.1:8000/users?page_index&#x3D;2&amp;page_size&#x3D;10</a></p>
<p>可以查看到结果</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707045162992-1bef0135-d752-4f97-ba83-c02279323ba3.png"></p>
<h2 id="查询参数的校验"><a href="#查询参数的校验" class="headerlink" title="查询参数的校验"></a>查询参数的校验</h2><ul>
<li>同样，在方法中的类型声明，会自动帮我们做类型验证，如果输入的类型与声明类型不符，会报错</li>
</ul>
<p>如果键入：<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/users?page_index=2&page_size=a">http://127.0.0.1:8000/users?page_index&#x3D;2&amp;page_size&#x3D;a</a></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707045310082-94901e0b-a96c-42ea-b3d9-49e774695eb1.png"></p>
<p>使用 swagger-UI 也会帮我们做参数类型校验</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707045530971-44dee988-4786-4acd-b1c4-182381abbed8.png"></p>
<h2 id="配置可选查询参数"><a href="#配置可选查询参数" class="headerlink" title="配置可选查询参数"></a>配置可选查询参数</h2><ul>
<li>使用<code>Optional</code>声明可选查询参数，若查询参数不传值，希望有一个默认值</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>(<span class="params">page_index: <span class="built_in">int</span>, page_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">10</span></span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Jane Guilherme&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    page_info = &#123;</span><br><span class="line">        <span class="string">&quot;page_index&quot;</span>: page_index,</span><br><span class="line">        <span class="string">&quot;page_size&quot;</span>: page_size</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user, <span class="string">&quot;page_info&quot;</span>: page_info&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707045815334-ea4a2029-1f18-45d2-bec8-ebe9bab5ac60.png"></p>
<h2 id="路径参数与查询参数混用"><a href="#路径参数与查询参数混用" class="headerlink" title="路径参数与查询参数混用"></a>路径参数与查询参数混用</h2><p>结合上一节的路径参数，可以与查询参数混合使用，并且在方法参数中的顺序是没有要求的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>(<span class="params">page_index: <span class="built_in">int</span>, page_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">10</span></span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Jane Guilherme&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    page_info = &#123;</span><br><span class="line">        <span class="string">&quot;page_index&quot;</span>: page_index,</span><br><span class="line">        <span class="string">&quot;page_size&quot;</span>: page_size</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user, <span class="string">&quot;page_info&quot;</span>: page_info&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;/friends&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user_friends</span>(<span class="params">user_id: <span class="built_in">int</span>, page_index: <span class="built_in">int</span>, page_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">10</span></span>):</span><br><span class="line">    user_friends = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: user_id + <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    page_info = &#123;</span><br><span class="line">        <span class="string">&quot;page_index&quot;</span>: page_index,</span><br><span class="line">        <span class="string">&quot;page_size&quot;</span>: page_size</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user_friends&quot;</span>: user_friends, <span class="string">&quot;page_info&quot;</span>: page_info&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707046682903-a73317e2-1d79-421b-a995-a0d9e2e8bc67.png"></p>
<h1 id="请求体"><a href="#请求体" class="headerlink" title="请求体"></a>请求体</h1><h2 id="什么是请求体"><a href="#什么是请求体" class="headerlink" title="什么是请求体"></a>什么是请求体</h2><p>请求体是用于发送数据给 API</p>
<ul>
<li><code>不能</code>使用<code>GET</code>请求发送请求体</li>
<li>发送请求体的类型应该是<code>POST</code>、<code>PUT</code>、<code>DELETE</code>或者<code>PATCH</code></li>
</ul>
<h2 id="定义请求体中数据的模型"><a href="#定义请求体中数据的模型" class="headerlink" title="定义请求体中数据的模型"></a>定义请求体中数据的模型</h2><ul>
<li>使用<code>pydantic</code>模块下的<code>BaseModel</code></li>
</ul>
<p>在项目目录下创建一个<code>/request_body</code>目录，然后创建一个<code>main.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserModel</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;No description&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/users&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">user: UserModel</span>):</span><br><span class="line">    <span class="comment"># 做一些创建用户的数据库操作</span></span><br><span class="line">    user = user.model_dump()</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>只传入非 Optional 的参数：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707048070716-44763888-00cc-40fc-9ffe-477331ae5c4c.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707048090712-348bc5a6-4394-40fd-8452-23870059f0e6.png"></p>
<p>给可选参数传入值</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707048141091-1db22a27-6b46-4e00-96fb-7a9adf05d7f0.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707048147968-e7fcc52e-16a7-48b1-9c8b-0751e7c895bb.png"></p>
<p>不给非可选参数传值，会报错，指出缺少的参数信息</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707048177095-56623673-2c5b-4ceb-8cf9-b2e0f5091ebe.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707048195592-4d019080-91f0-476b-ae8e-8ec383643a2e.png"></p>
<h2 id="请求体中定义枚举选择项"><a href="#请求体中定义枚举选择项" class="headerlink" title="请求体中定义枚举选择项"></a>请求体中定义枚举选择项</h2><p>在前面的路径参数中，对一些参数可以使用选择项进行输入，那么同样在请求体中的某些参数也可以配置为枚举类进行选择项输入</p>
<ul>
<li>枚举类定义选择项</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Gender</span>(<span class="built_in">str</span>, Enum):</span><br><span class="line">    male = <span class="string">&quot;男性&quot;</span></span><br><span class="line">    female = <span class="string">&quot;女性&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserModel</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span></span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    gender: Gender</span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;No description&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/users&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">user: UserModel</span>):</span><br><span class="line">    <span class="comment"># 做一些创建用户的数据库操作</span></span><br><span class="line">    user = user.model_dump()</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707048572427-2f033902-4fad-4629-ba34-97f464170a4c.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707048608299-5128c520-5f93-436f-b3f1-091f00ed80ce.png"></p>
<ul>
<li>会对枚举选择项，自动做内容校验</li>
</ul>
<p>输入错误的枚举类型，结果会报错，具体错误信息</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707048649367-08ae01ec-dba3-467f-a50f-e2eb4edb5a2a.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707048654880-0699ff76-da49-4122-9a80-24794bb35800.png"></p>
<h2 id="请求体与路径参数混用"><a href="#请求体与路径参数混用" class="headerlink" title="请求体与路径参数混用"></a>请求体与路径参数混用</h2><p>这块逻辑需要先改一下</p>
<p>因为对于更新数据而言，我们可能请求体发送的时候只是发送要更新的数据，我们一般不会知道 id 是多少，所以 UserModel 先去掉 id，然后在修改完之后给他从路径参数中把 id 加过来</p>
<p>实际上在开发的时候这些 User 类就要做一下区分：如 UserVO，User，UserDTO 等等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Gender</span>(<span class="built_in">str</span>, Enum):</span><br><span class="line">    male = <span class="string">&quot;男性&quot;</span></span><br><span class="line">    female = <span class="string">&quot;女性&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserModel</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    gender: Gender</span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;No description&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/users&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">user: UserModel</span>):</span><br><span class="line">    <span class="comment"># 做一些创建用户的数据库操作</span></span><br><span class="line">    user = user.model_dump()</span><br><span class="line">    user.update(&#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_user</span>(<span class="params">user_id: <span class="built_in">int</span>, user: UserModel</span>):</span><br><span class="line">    <span class="comment"># 做一些更新用户的数据库操作</span></span><br><span class="line">    user = user.model_dump()</span><br><span class="line">    user.update(&#123;<span class="string">&quot;id&quot;</span>: user_id&#125;)</span><br><span class="line">    <span class="keyword">return</span> user</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707049286137-3ab2b411-2654-45e1-88d5-81e0c414171c.png"><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707049307115-b356f9eb-7ec2-4406-a587-ed13f8c9e076.png"></p>
<h2 id="函数的参数识别规则"><a href="#函数的参数识别规则" class="headerlink" title="函数的参数识别规则"></a>函数的参数识别规则</h2><ul>
<li>FastAPI 如何区分方法中的路径参数、查询参数、请求体对象<ul>
<li>如果在路径参数中定义了，函数的参数会匹配为路径参数</li>
<li>如果路径参数中没有定义，然后函数的参数定义为 int、str 等基础类型，会匹配为查询参数</li>
<li>如果是 pydantic 模型类（继承 BaseModel），则匹配为请求体</li>
</ul>
</li>
</ul>
<h1 id="参数验证"><a href="#参数验证" class="headerlink" title="参数验证"></a>参数验证</h1><p>目录路径下创建一个<code>/params_validation</code>目录，然后创建一个<code>main.py</code></p>
<h2 id="路径参数的验证"><a href="#路径参数的验证" class="headerlink" title="路径参数的验证"></a>路径参数的验证</h2><ul>
<li>使用<code>fastapi.Path</code>类实现</li>
<li><code>路径参数都是必须项</code></li>
<li>格式：<ul>
<li><code>...</code>表示该路径参数必填</li>
<li><code>title</code>表示对该路径参数的名称</li>
<li><code>ge</code>值大于等于，<code>gt</code>大于</li>
<li><code>le</code>值小于等于，<code>lt</code>小于</li>
<li><code>min_length</code> 字符串最小长度</li>
<li><code>max_length</code> 字符串最大长度</li>
<li><code>regex</code>正则表达式验证 常用格式<code>r&quot;^[正则内容]$&quot;</code></li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">user_id: <span class="built_in">int</span> = Path(<span class="params">...,</span></span></span><br><span class="line"><span class="params"><span class="params">                                       title=<span class="string">&quot;The ID of the user to get&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">                                       ge=<span class="number">1</span>,</span></span></span><br><span class="line"><span class="params"><span class="params">                                       le=<span class="number">200</span></span>)</span>):</span><br></pre></td></tr></table></figure>

<p>下面看一下具体实例</p>
<h3 id="整数类型验证"><a href="#整数类型验证" class="headerlink" title="整数类型验证"></a>整数类型验证</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">user_id: <span class="built_in">int</span> = Path(<span class="params">..., title=<span class="string">&quot;The ID of the user to get&quot;</span>, ge=<span class="number">1</span>, le=<span class="number">200</span></span>)</span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: user_id,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707050391425-d8504338-b4e5-4f0d-a625-bb5e29c97167.png"></p>
<p>路径参数会显示最大值最小值范围，若输入不在范围，则会报错</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707050426921-03e10477-0fa1-4f93-bb04-ef05a30be97e.png"></p>
<p>上面这个例子是一个整数的类型，下面来一个字符串类型的验证</p>
<h3 id="字符串类型验证"><a href="#字符串类型验证" class="headerlink" title="字符串类型验证"></a>字符串类型验证</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">user_id: <span class="built_in">int</span> = Path(<span class="params">..., title=<span class="string">&quot;The ID of the user to get&quot;</span>, ge=<span class="number">1</span>, le=<span class="number">200</span></span>)</span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: user_id,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/books/&#123;book_name&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_book</span>(<span class="params">book_name: <span class="built_in">str</span> = Path(<span class="params">..., title=<span class="string">&quot;The name of the book to get&quot;</span>, min_length=<span class="number">3</span>, max_length=<span class="number">10</span></span>)</span>):</span><br><span class="line">    book = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: book_name,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The description of the book...&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;book&quot;</span>: book&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707050907070-6427adc9-a378-4aeb-b5ec-0bf0b0d94686.png"></p>
<h3 id="正则表达式验证"><a href="#正则表达式验证" class="headerlink" title="正则表达式验证"></a>正则表达式验证</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">user_id: <span class="built_in">int</span> = Path(<span class="params">..., title=<span class="string">&quot;The ID of the user to get&quot;</span>, ge=<span class="number">1</span>, le=<span class="number">200</span></span>)</span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: user_id,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/books/&#123;book_name&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_book</span>(<span class="params">book_name: <span class="built_in">str</span> = Path(<span class="params">..., title=<span class="string">&quot;The name of the book to get&quot;</span>, min_length=<span class="number">3</span>, max_length=<span class="number">10</span></span>)</span>):</span><br><span class="line">    book = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: book_name,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The description of the book...&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;book&quot;</span>: book&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/milkteas/&#123;milktea_name&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_milktea</span>(<span class="params"></span></span><br><span class="line"><span class="params">        milktea_name: <span class="built_in">str</span> = Path(<span class="params">..., title=<span class="string">&quot;The name of the milktea to get&quot;</span>, regex=<span class="string">r&quot;^.*茶$&quot;</span>, min_length=<span class="number">2</span></span>)</span>):</span><br><span class="line">    milktea = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: milktea_name,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The description of the milktea...&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;milktea&quot;</span>: milktea&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>实现了一个查询奶茶的 api，其中要求奶茶名必须是茶结尾，并且字符串长度大于等于 2</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707051497644-98ca4598-2b08-4111-850e-dd73c3d39cc1.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707051517045-ed3a752d-3a49-4bc7-a7a4-bbf882dfbccf.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707051528566-76ad558c-837e-4752-b0b0-65ea0d29ec00.png"></p>
<h2 id="查询参数的验证"><a href="#查询参数的验证" class="headerlink" title="查询参数的验证"></a>查询参数的验证</h2><ul>
<li>使用<code>fastapi.Query</code>类实现</li>
<li>使用方法与<code>Path</code>大体一致</li>
<li>区别在于：<ul>
<li><code>Query(..., )</code>表示该查询参数为<code>必选项</code></li>
<li><code>Query(None, )</code>表示该查询参数为 <code>可选项</code>，其中<code>None可以是任何内容</code>表示默认值</li>
<li><code>Query(alias=&quot;[别名]&quot;)</code>设置查询参数别名，起了别名之后原先参数名<code>失效</code></li>
</ul>
</li>
</ul>
<h3 id="整数类型验证-1"><a href="#整数类型验证-1" class="headerlink" title="整数类型验证"></a>整数类型验证</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/current&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>(<span class="params">page_index: <span class="built_in">int</span> = Query(<span class="params"><span class="number">1</span>, ge=<span class="number">1</span>, le=<span class="number">100</span></span>),</span></span><br><span class="line"><span class="params">                           page_size: <span class="built_in">int</span> = Query(<span class="params"><span class="number">10</span>, ge=<span class="number">1</span>, le=<span class="number">100</span></span>)</span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Jane Guilherme&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    page_info = &#123;</span><br><span class="line">        <span class="string">&quot;page_index&quot;</span>: page_index,</span><br><span class="line">        <span class="string">&quot;page_size&quot;</span>: page_size</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user, <span class="string">&quot;page_info&quot;</span>: page_info&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">user_id: <span class="built_in">int</span> = Path(<span class="params">..., title=<span class="string">&quot;The ID of the user to get&quot;</span>, ge=<span class="number">1</span>, le=<span class="number">200</span></span>)</span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: user_id,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/books/&#123;book_name&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_book</span>(<span class="params">book_name: <span class="built_in">str</span> = Path(<span class="params">..., title=<span class="string">&quot;The name of the book to get&quot;</span>, min_length=<span class="number">3</span>, max_length=<span class="number">10</span></span>)</span>):</span><br><span class="line">    book = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: book_name,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The description of the book...&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;book&quot;</span>: book&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/milkteas/&#123;milktea_name&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_milktea</span>(<span class="params"></span></span><br><span class="line"><span class="params">        milktea_name: <span class="built_in">str</span> = Path(<span class="params">..., title=<span class="string">&quot;The name of the milktea to get&quot;</span>, regex=<span class="string">r&quot;^.*茶$&quot;</span>, min_length=<span class="number">2</span></span>)</span>):</span><br><span class="line">    milktea = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: milktea_name,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The description of the milktea...&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;milktea&quot;</span>: milktea&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707052014833-3ce44098-4ea2-44f4-9e9a-c8e9e5e35608.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707052914753-60b26e2f-3865-4b2b-85b7-3418d9c1e2c0.png"></p>
<h3 id="查询参数别名"><a href="#查询参数别名" class="headerlink" title="查询参数别名"></a>查询参数别名</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path, Query</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/current&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_current_user</span>(<span class="params">page_index: <span class="built_in">int</span> = Query(<span class="params"><span class="number">1</span>, alias=<span class="string">&quot;page-index&quot;</span>, ge=<span class="number">1</span>, le=<span class="number">100</span></span>),</span></span><br><span class="line"><span class="params">                           page_size: <span class="built_in">int</span> = Query(<span class="params"><span class="number">10</span>, alias=<span class="string">&quot;page-size&quot;</span>, ge=<span class="number">1</span>, le=<span class="number">100</span></span>)</span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Jane Guilherme&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    page_info = &#123;</span><br><span class="line">        <span class="string">&quot;page_index&quot;</span>: page_index,</span><br><span class="line">        <span class="string">&quot;page_size&quot;</span>: page_size</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user, <span class="string">&quot;page_info&quot;</span>: page_info&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;user_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">user_id: <span class="built_in">int</span> = Path(<span class="params">..., title=<span class="string">&quot;The ID of the user to get&quot;</span>, ge=<span class="number">1</span>, le=<span class="number">200</span></span>)</span>):</span><br><span class="line">    user = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: user_id,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;user&quot;</span>: user&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/books/&#123;book_name&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_book</span>(<span class="params">book_name: <span class="built_in">str</span> = Path(<span class="params">..., title=<span class="string">&quot;The name of the book to get&quot;</span>, min_length=<span class="number">3</span>, max_length=<span class="number">10</span></span>)</span>):</span><br><span class="line">    book = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: book_name,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The description of the book...&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;book&quot;</span>: book&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/milkteas/&#123;milktea_name&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_milktea</span>(<span class="params"></span></span><br><span class="line"><span class="params">        milktea_name: <span class="built_in">str</span> = Path(<span class="params">..., title=<span class="string">&quot;The name of the milktea to get&quot;</span>, regex=<span class="string">r&quot;^.*茶$&quot;</span>, min_length=<span class="number">2</span></span>)</span>):</span><br><span class="line">    milktea = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: milktea_name,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;The description of the milktea...&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;milktea&quot;</span>: milktea&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>起了查询参数别名之后，可以键入：<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/users/current?page-index=2&page-size=10">http://127.0.0.1:8000/users/current?page-index=2&page-size=10</a></p>
<p>这时如果还使用原先的查询参数就会失效啦，会使用默认值而不是传入的值</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707053331667-69b228ae-c6d5-492d-aa3c-b494cfb0bc3e.png"></p>
<h1 id="请求体-进阶"><a href="#请求体-进阶" class="headerlink" title="请求体-进阶"></a>请求体-进阶</h1><p>创建一个<code>/request_body_advance</code>目录，然后创建一个<code>main.py</code></p>
<h2 id="多个请求体参数"><a href="#多个请求体参数" class="headerlink" title="多个请求体参数"></a>多个请求体参数</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;No description&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    number: <span class="built_in">int</span></span><br><span class="line">    goods: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/carts/&#123;cart_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_cart</span>(<span class="params">cart_id: <span class="built_in">int</span>, user: User, order: Order</span>):</span><br><span class="line">    <span class="comment"># 做一些更新购物车的数据库操作</span></span><br><span class="line">    result = &#123;</span><br><span class="line">        <span class="string">&quot;cart_id&quot;</span>: cart_id,</span><br><span class="line">        <span class="string">&quot;user_name&quot;</span>: user.name,</span><br><span class="line">        <span class="string">&quot;order_good&quot;</span>: order.goods</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707054123353-c69769ae-253a-4877-aecc-b70515a4d798.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707054143792-f8f3c6d0-3cd9-450b-8a84-eca2844cc6b6.png"></p>
<h2 id="单一数据类型作为请求体参数"><a href="#单一数据类型作为请求体参数" class="headerlink" title="单一数据类型作为请求体参数"></a>单一数据类型作为请求体参数</h2><p>当函数参数列表中有一个 int 或者 str 类型的单一数据类型时，API 会默认将它作为一个查询参数，那么我们应该怎么做让其声明为一个请求体参数呢</p>
<ul>
<li>使用<code>fastapi.Body</code>类声明，使用方法与上面的 Path、Query 大体相同</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Body</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;No description&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    number: <span class="built_in">int</span></span><br><span class="line">    goods: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/carts/&#123;cart_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_cart</span>(<span class="params">cart_id: <span class="built_in">int</span>, user: User, order: Order,</span></span><br><span class="line"><span class="params">                      total_price: <span class="built_in">float</span> = Body(<span class="params">...</span>)</span>):</span><br><span class="line">    <span class="comment"># 做一些更新购物车的数据库操作</span></span><br><span class="line">    result = &#123;</span><br><span class="line">        <span class="string">&quot;cart_id&quot;</span>: cart_id,</span><br><span class="line">        <span class="string">&quot;user_name&quot;</span>: user.name,</span><br><span class="line">        <span class="string">&quot;order_good&quot;</span>: order.goods,</span><br><span class="line">        <span class="string">&quot;total_price&quot;</span>: total_price</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>这时 total_price 可以作为请求体参数发给 API</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707054461374-7cef6692-b992-4621-9780-1624838070d5.png"></p>
<h2 id="请求体模型中的属性验证"><a href="#请求体模型中的属性验证" class="headerlink" title="请求体模型中的属性验证"></a>请求体模型中的属性验证</h2><ul>
<li>使用<code>pydantic.Field</code>进行验证</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Body</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(..., min_length=<span class="number">4</span>)</span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(<span class="string">&quot;No description&quot;</span>, min_length=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    number: <span class="built_in">int</span> = Field(..., ge=<span class="number">1</span>)</span><br><span class="line">    goods: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/carts/&#123;cart_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_cart</span>(<span class="params">cart_id: <span class="built_in">int</span>, user: User, order: Order,</span></span><br><span class="line"><span class="params">                      total_price: <span class="built_in">float</span> = Body(<span class="params">...</span>)</span>):</span><br><span class="line">    <span class="comment"># 做一些更新购物车的数据库操作</span></span><br><span class="line">    result = &#123;</span><br><span class="line">        <span class="string">&quot;cart_id&quot;</span>: cart_id,</span><br><span class="line">        <span class="string">&quot;user_name&quot;</span>: user.name,</span><br><span class="line">        <span class="string">&quot;order_good&quot;</span>: order.goods,</span><br><span class="line">        <span class="string">&quot;total_price&quot;</span>: total_price</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>错误的参数：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707054970993-265c30c5-71c4-474e-ac10-dbaac3e702ab.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707054983373-38c1ed93-5389-493c-938b-b2464dfff5c3.png"></p>
<p>正确的参数：</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707055064014-36335deb-d13c-478d-b577-443b933c1e37.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707055074715-b30a5587-75e9-4691-8f0c-dd63ed9960e7.png"></p>
<h2 id="请求体模型嵌套"><a href="#请求体模型嵌套" class="headerlink" title="请求体模型嵌套"></a>请求体模型嵌套</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Body</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Address</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    province: <span class="built_in">str</span></span><br><span class="line">    city: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(..., min_length=<span class="number">4</span>)</span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(<span class="string">&quot;No description&quot;</span>, min_length=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    number: <span class="built_in">int</span> = Field(..., ge=<span class="number">1</span>)</span><br><span class="line">    goods: <span class="built_in">str</span></span><br><span class="line">    address: Address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/carts/&#123;cart_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_cart</span>(<span class="params">cart_id: <span class="built_in">int</span>, user: User, order: Order,</span></span><br><span class="line"><span class="params">                      total_price: <span class="built_in">float</span> = Body(<span class="params">...</span>)</span>):</span><br><span class="line">    <span class="comment"># 做一些更新购物车的数据库操作</span></span><br><span class="line">    result = &#123;</span><br><span class="line">        <span class="string">&quot;cart_id&quot;</span>: cart_id,</span><br><span class="line">        <span class="string">&quot;user_name&quot;</span>: user.name,</span><br><span class="line">        <span class="string">&quot;order_good&quot;</span>: order.goods,</span><br><span class="line">        <span class="string">&quot;total_price&quot;</span>: total_price</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707056351769-ea6c7b5d-3a68-4b68-a4a4-634ced8f15f4.png"></p>
<h2 id="模型内使用-list、set-等数据结构"><a href="#模型内使用-list、set-等数据结构" class="headerlink" title="模型内使用 list、set 等数据结构"></a>模型内使用 list、set 等数据结构</h2><ul>
<li><code>goods: List[str]</code></li>
<li><code>goods: list</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Body</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Address</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    province: <span class="built_in">str</span></span><br><span class="line">    city: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(..., min_length=<span class="number">4</span>)</span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(<span class="string">&quot;No description&quot;</span>, min_length=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    number: <span class="built_in">int</span> = Field(..., ge=<span class="number">1</span>)</span><br><span class="line">    goods: <span class="type">List</span>[<span class="built_in">str</span>] = Field(..., min_items=<span class="number">1</span>)</span><br><span class="line">    address: Address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/carts/&#123;cart_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_cart</span>(<span class="params">cart_id: <span class="built_in">int</span>, user: User, order: Order,</span></span><br><span class="line"><span class="params">                      total_price: <span class="built_in">float</span> = Body(<span class="params">...</span>)</span>):</span><br><span class="line">    <span class="comment"># 做一些更新购物车的数据库操作</span></span><br><span class="line">    result = &#123;</span><br><span class="line">        <span class="string">&quot;cart_id&quot;</span>: cart_id,</span><br><span class="line">        <span class="string">&quot;user_name&quot;</span>: user.name,</span><br><span class="line">        <span class="string">&quot;order_good&quot;</span>: order.goods,</span><br><span class="line">        <span class="string">&quot;total_price&quot;</span>: total_price</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707057788248-93702cb0-b467-4ef3-aaa8-a645d298f698.png"></p>
<h1 id="示例数据"><a href="#示例数据" class="headerlink" title="示例数据"></a>示例数据</h1><p>在 swagger-UI 中每一个 API 会有一个默认的示例数据</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707058017114-77e5318e-0116-42fa-8813-9f8b45e95cc0.png"></p>
<p>示例数据是显示在文档中的例子，可以给使用者提供示例数据格式，可视化更直接，更便于使用者理解 API 如何使用</p>
<p><code>Body &gt; model_config &gt; Field</code></p>
<p>但是更推荐使用<code>Field</code>，因为如果请求体数据模型有修改，会更便利</p>
<h2 id="通过-Field-定义示例数据"><a href="#通过-Field-定义示例数据" class="headerlink" title="通过 Field 定义示例数据"></a>通过 Field 定义示例数据</h2><ul>
<li><code>Field(..., examples=[&quot;具体数据&quot;])</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Body</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Address</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    province: <span class="built_in">str</span> = Field(..., examples=[<span class="string">&quot;广东省&quot;</span>])</span><br><span class="line">    city: <span class="built_in">str</span> = Field(..., examples=[<span class="string">&quot;深圳市&quot;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(..., min_length=<span class="number">4</span>, examples=[<span class="string">&quot;Zachary&quot;</span>])</span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(<span class="string">&quot;No description&quot;</span>, min_length=<span class="number">10</span>, examples=[<span class="string">&quot;该用户是新人，拥有新人优惠券&quot;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    number: <span class="built_in">int</span> = Field(..., ge=<span class="number">1</span>, examples=[<span class="number">1</span>])</span><br><span class="line">    goods: <span class="type">List</span>[<span class="built_in">str</span>] = Field(..., min_items=<span class="number">1</span>, examples=[[<span class="string">&quot;苹果&quot;</span>, <span class="string">&quot;香蕉&quot;</span>]])</span><br><span class="line">    address: Address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/carts/&#123;cart_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_cart</span>(<span class="params">cart_id: <span class="built_in">int</span>, user: User, order: Order,</span></span><br><span class="line"><span class="params">                      total_price: <span class="built_in">float</span> = Body(<span class="params">...</span>)</span>):</span><br><span class="line">    <span class="comment"># 做一些更新购物车的数据库操作</span></span><br><span class="line">    result = &#123;</span><br><span class="line">        <span class="string">&quot;cart_id&quot;</span>: cart_id,</span><br><span class="line">        <span class="string">&quot;user_name&quot;</span>: user.name,</span><br><span class="line">        <span class="string">&quot;order_good&quot;</span>: order.goods,</span><br><span class="line">        <span class="string">&quot;total_price&quot;</span>: total_price</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707058646445-50ff0b60-e27f-4411-8704-a4e10694fb45.png"></p>
<h2 id="通过定义模型属性-model-config"><a href="#通过定义模型属性-model-config" class="headerlink" title="通过定义模型属性 model_config"></a>通过定义模型属性 model_config</h2><ul>
<li><code>model_config</code>优先级更高</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Body</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Address</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    province: <span class="built_in">str</span> = Field(...)</span><br><span class="line">    city: <span class="built_in">str</span> = Field(...)</span><br><span class="line">    model_config = &#123;</span><br><span class="line">        <span class="string">&quot;json_schema_extra&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;examples&quot;</span>: [&#123;</span><br><span class="line">                <span class="string">&quot;province&quot;</span>: <span class="string">&quot;江苏省&quot;</span>,</span><br><span class="line">                <span class="string">&quot;city&quot;</span>: <span class="string">&quot;南京市&quot;</span></span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(..., min_length=<span class="number">4</span>)</span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(<span class="string">&quot;No description&quot;</span>, min_length=<span class="number">10</span>)</span><br><span class="line">    model_config = &#123;</span><br><span class="line">        <span class="string">&quot;json_schema_extra&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;examples&quot;</span>: [&#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Zachary&quot;</span>,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;该用户是新人，拥有新人优惠券&quot;</span></span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    number: <span class="built_in">int</span> = Field(..., ge=<span class="number">1</span>, examples=[<span class="number">1</span>])</span><br><span class="line">    goods: <span class="type">List</span>[<span class="built_in">str</span>] = Field(..., min_items=<span class="number">1</span>, examples=[[<span class="string">&quot;苹果&quot;</span>, <span class="string">&quot;香蕉&quot;</span>]])</span><br><span class="line">    address: Address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/carts/&#123;cart_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_cart</span>(<span class="params">cart_id: <span class="built_in">int</span>, user: User, order: Order,</span></span><br><span class="line"><span class="params">                      total_price: <span class="built_in">float</span> = Body(<span class="params">...</span>)</span>):</span><br><span class="line">    <span class="comment"># 做一些更新购物车的数据库操作</span></span><br><span class="line">    result = &#123;</span><br><span class="line">        <span class="string">&quot;cart_id&quot;</span>: cart_id,</span><br><span class="line">        <span class="string">&quot;user_name&quot;</span>: user.name,</span><br><span class="line">        <span class="string">&quot;order_good&quot;</span>: order.goods,</span><br><span class="line">        <span class="string">&quot;total_price&quot;</span>: total_price</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707059248961-cb053a74-2212-4674-95fc-5b8dfdce59ec.png"></p>
<h2 id="通过-Body-定义示例数据"><a href="#通过-Body-定义示例数据" class="headerlink" title="通过 Body 定义示例数据"></a>通过 Body 定义示例数据</h2><ul>
<li><code>Body</code>主要是定义单一数据类型作为请求体参数时用的，但同时请求体数据模型也适用<code>Body</code>进行配置</li>
<li><code>Body</code>优先级最高</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> enum <span class="keyword">import</span> Enum</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Body</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel, Field</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Address</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    province: <span class="built_in">str</span> = Field(...)</span><br><span class="line">    city: <span class="built_in">str</span> = Field(...)</span><br><span class="line">    model_config = &#123;</span><br><span class="line">        <span class="string">&quot;json_schema_extra&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;examples&quot;</span>: [&#123;</span><br><span class="line">                <span class="string">&quot;province&quot;</span>: <span class="string">&quot;江苏省&quot;</span>,</span><br><span class="line">                <span class="string">&quot;city&quot;</span>: <span class="string">&quot;南京市&quot;</span></span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span> = Field(..., min_length=<span class="number">4</span>)</span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = Field(<span class="string">&quot;No description&quot;</span>, min_length=<span class="number">10</span>)</span><br><span class="line">    model_config = &#123;</span><br><span class="line">        <span class="string">&quot;json_schema_extra&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;examples&quot;</span>: [&#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Zachary&quot;</span>,</span><br><span class="line">                <span class="string">&quot;description&quot;</span>: <span class="string">&quot;该用户是新人，拥有新人优惠券&quot;</span></span><br><span class="line">            &#125;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Order</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    number: <span class="built_in">int</span> = Field(..., ge=<span class="number">1</span>, examples=[<span class="number">1</span>])</span><br><span class="line">    goods: <span class="type">List</span>[<span class="built_in">str</span>] = Field(..., min_items=<span class="number">1</span>, examples=[[<span class="string">&quot;苹果&quot;</span>, <span class="string">&quot;香蕉&quot;</span>]])</span><br><span class="line">    address: Address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/carts/&#123;cart_id&#125;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_cart</span>(<span class="params">cart_id: <span class="built_in">int</span>, user: User, order: Order,</span></span><br><span class="line"><span class="params">                      total_price: <span class="built_in">float</span> = Body(<span class="params">..., examples=[<span class="number">188888.88</span>]</span>)</span>):</span><br><span class="line">    <span class="comment"># 做一些更新购物车的数据库操作</span></span><br><span class="line">    result = &#123;</span><br><span class="line">        <span class="string">&quot;cart_id&quot;</span>: cart_id,</span><br><span class="line">        <span class="string">&quot;user_name&quot;</span>: user.name,</span><br><span class="line">        <span class="string">&quot;order_good&quot;</span>: order.goods,</span><br><span class="line">        <span class="string">&quot;total_price&quot;</span>: total_price</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707059378150-713230a0-363b-446b-990a-05bbcdfa55f8.png"></p>
<p>这里提及一个小技巧</p>
<ul>
<li>对方法来说，如果<code>def func(*, num1, num2)</code>参数列表的第一个<code>*</code>把所有位置参数占了，后面的所有参数都是关键字参数，并且没有顺序</li>
</ul>
<h1 id="Cookie-与-Header-参数"><a href="#Cookie-与-Header-参数" class="headerlink" title="Cookie 与 Header 参数"></a>Cookie 与 Header 参数</h1><p>创建一个目录<code>/cookie_header</code>，然后在这其中创建一个<code>main.py</code></p>
<ul>
<li>放在 cookie 中的键值对数据，常用的键不使用<code>_</code>连接，常用<code>-</code>，但是用<code>-</code>不符合 Python 编程规范，因此可以设置别名</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Cookie, Header</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/cookieAndHeader&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">cookie_and_header</span>(<span class="params">*,</span></span><br><span class="line"><span class="params">                            favorite_schema: <span class="type">Optional</span>[<span class="built_in">str</span>] = Cookie(<span class="params">default=<span class="literal">None</span>, alias=<span class="string">&quot;favorite-schema&quot;</span></span>),</span></span><br><span class="line"><span class="params">                            api_token: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = Header(<span class="params">default=<span class="literal">None</span>, alias=<span class="string">&quot;api-token&quot;</span></span>)</span>):</span><br><span class="line">    result_dict = &#123;</span><br><span class="line">        <span class="string">&quot;favorite_schema&quot;</span>: favorite_schema,</span><br><span class="line">        <span class="string">&quot;api_token&quot;</span>: api_token</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707406513044-c5cb7f20-5642-4b03-9b01-ee0b69af1357.png"></p>
<p>但是尝试测试可以发现，在 swagger-UI 里面无法显示 cookie 的内容</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707406815558-1bba0927-e00f-484b-8e11-3f146fc58f36.png"></p>
<p>这是由于浏览器的原因，需要使用 postman 来测试，设置好 header 和 cookie</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707406933913-8184d61f-fd00-4ea8-abcf-daeda9b40331.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707407046247-e62a249d-fbeb-412c-8dd4-0742ef533e37.png"></p>
<p>这时，可以获得完整的 cookie</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707407101023-77730316-fd43-4e55-9f63-b530504a4b01.png"></p>
<p>如果一定想要通过 swagger-UI 来实现 cookie 的查看，需要设置一下 cookie</p>
<ul>
<li>通过<code>Response</code>来设置 cookie 的内容，实际上这个 Response 就是发送给客户端结果的</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">Union</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Cookie, Header, Response</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&quot;/cookieAndHeader&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">cookie_and_header</span>(<span class="params">*,</span></span><br><span class="line"><span class="params">                            response: Response,</span></span><br><span class="line"><span class="params">                            favorite_schema: <span class="type">Optional</span>[<span class="built_in">str</span>] = Cookie(<span class="params">default=<span class="literal">None</span>, alias=<span class="string">&quot;favorite-schema&quot;</span></span>),</span></span><br><span class="line"><span class="params">                            api_token: <span class="type">Union</span>[<span class="built_in">str</span>, <span class="literal">None</span>] = Header(<span class="params">default=<span class="literal">None</span>, alias=<span class="string">&quot;api-token&quot;</span></span>)</span>):</span><br><span class="line">    result_dict = &#123;</span><br><span class="line">        <span class="string">&quot;favorite_schema&quot;</span>: favorite_schema,</span><br><span class="line">        <span class="string">&quot;api_token&quot;</span>: api_token</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    response.set_cookie(key=<span class="string">&quot;favorite-schema&quot;</span>, value=<span class="string">&quot;black&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> result_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>之后再去 swagger-UI 查看的时候，第一次调用仍旧没有 cookie，但是服务端进行了设置，第二次调用的时候，就能看到服务端所设置的 cookie 了</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707409204328-7972b14d-d8d3-4550-ace0-a09e94e92f90.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707409212045-76ef60f0-cb6f-4597-b6ea-62378dab797b.png"></p>
<h1 id="响应模型"><a href="#响应模型" class="headerlink" title="响应模型"></a>响应模型</h1><p>在 swagger-UI 中，我们只能得到一个响应模型的精简例子，只能知道返回的内容是什么类型，不能知道一个具体格式</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707409407269-da3b51fc-0aa4-4dd1-b8b2-f37272dca11e.png"></p>
<p>在项目路径下创建一个<code>/response_model</code>，然后创建一个<code>main.py</code></p>
<h2 id="定义响应模型"><a href="#定义响应模型" class="headerlink" title="定义响应模型"></a>定义响应模型</h2><ul>
<li><code>response_model</code>指定响应模型</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">users = &#123;</span><br><span class="line">    <span class="string">&quot;s&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">0</span>&#125;,</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;a&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;b&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;bbb&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;c&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;c&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ccc&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;default&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;d&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">4</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;d&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ddd&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user d&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;e&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">5</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;e&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;eee&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user e&quot;</span>, <span class="string">&quot;fullname&quot;</span>: <span class="string">&quot;Tony Stark&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserOut</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    password: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line">    fullname: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;username&#125;&quot;</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">username: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> users.get(username, &#123;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>这时查看一下 responses，就能看出来返回结果具体包括的内容</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707410720903-929a6d12-acde-4a3e-8e50-7b68fd0afe09.png"></p>
<ul>
<li><code>resoinse_model_include</code>可以指定响应模型只输出的内容</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">users = &#123;</span><br><span class="line">    <span class="string">&quot;s&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">0</span>&#125;,</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;a&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;b&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;bbb&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;c&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;c&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ccc&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;default&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;d&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">4</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;d&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ddd&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user d&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;e&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">5</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;e&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;eee&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user e&quot;</span>, <span class="string">&quot;fullname&quot;</span>: <span class="string">&quot;Tony Stark&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserOut</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    password: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line">    fullname: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;username&#125;&quot;</span>, response_model=UserOut, response_model_include=&#123;<span class="string">&quot;id&quot;</span>, <span class="string">&quot;username&quot;</span>, <span class="string">&quot;description&quot;</span>&#125;</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">username: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> users.get(username, &#123;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>这样的话 response 只有指定的</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707411019679-caaecaa3-e85a-4385-814c-ff4bda8a05a8.png"></p>
<ul>
<li><code>response_model_exclude</code>也是同样的用法</li>
<li><code>response_model_exclude_unset</code>如果数据包含这个值，就显示出来</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">users = &#123;</span><br><span class="line">    <span class="string">&quot;s&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">0</span>&#125;,</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;a&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;b&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;bbb&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;c&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;c&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ccc&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;default&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;d&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">4</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;d&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ddd&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user d&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;e&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">5</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;e&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;eee&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user e&quot;</span>, <span class="string">&quot;fullname&quot;</span>: <span class="string">&quot;Tony Stark&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserOut</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    password: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line">    fullname: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;username&#125;&quot;</span>, response_model=UserOut, response_model_exclude_unset=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">username: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> users.get(username, &#123;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707411247326-30800534-f931-4ab2-8bfe-17a305cd239f.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707411241304-8a3d43d7-5032-4558-bbc4-da74937fb43c.png"></p>
<h2 id="响应模型列表"><a href="#响应模型列表" class="headerlink" title="响应模型列表"></a>响应模型列表</h2><ul>
<li><code>response_model=List[User]</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span>, <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">users = &#123;</span><br><span class="line">    <span class="comment"># &quot;s&quot;: &#123;&quot;id&quot;: 0&#125;,</span></span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;a&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;b&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;bbb&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;c&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;c&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ccc&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;default&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;d&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">4</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;d&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ddd&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user d&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;e&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">5</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;e&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;eee&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user e&quot;</span>, <span class="string">&quot;fullname&quot;</span>: <span class="string">&quot;Tony Stark&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserOut</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    password: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line">    fullname: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;username&#125;&quot;</span>, response_model=UserOut, response_model_exclude_unset=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">username: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">return</span> users.get(username, &#123;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span>, response_model=<span class="type">List</span>[UserOut]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_users</span>():</span><br><span class="line">    <span class="keyword">return</span> users.values()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707411609525-144aa301-bf87-4489-ace9-95bde9962edc.png"></p>
<h1 id="状态码与异常处理"><a href="#状态码与异常处理" class="headerlink" title="状态码与异常处理"></a>状态码与异常处理</h1><p>创建一个<code>/exception_handler</code>目录，然后创建<code>main.py</code></p>
<h2 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h2><h3 id="返回指定状态码"><a href="#返回指定状态码" class="headerlink" title="返回指定状态码"></a>返回指定状态码</h3><ul>
<li><code>status_code=</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">users = &#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;a&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;b&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;bbb&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;c&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;c&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ccc&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;default&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;d&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">4</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;d&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ddd&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user d&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;e&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">5</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;e&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;eee&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user e&quot;</span>, <span class="string">&quot;fullname&quot;</span>: <span class="string">&quot;Tony Stark&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserBase</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line">    fullname: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserIn</span>(<span class="title class_ inherited__">UserBase</span>):</span><br><span class="line">    password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserOut</span>(<span class="title class_ inherited__">UserBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/users&quot;</span>, status_code=<span class="number">201</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">user: UserIn</span>):</span><br><span class="line">    user_dict = user.model_dump()</span><br><span class="line">    user_dict.update(&#123;<span class="string">&quot;id&quot;</span>: <span class="number">6</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> user_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707412478635-de8669e6-171b-4825-8c39-659ac7828f5e.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707412492955-d9d43006-1e3f-4bfa-94f3-20e1bc3ebbba.png"></p>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><h3 id="通过异常返回错误"><a href="#通过异常返回错误" class="headerlink" title="通过异常返回错误"></a>通过异常返回错误</h3><ul>
<li>通过抛出<code>HTTPException</code>来获得错误返回</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path, HTTPException, status</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">users = &#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;a&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;b&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;bbb&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;c&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;c&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ccc&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;default&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;d&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">4</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;d&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ddd&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user d&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;e&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">5</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;e&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;eee&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user e&quot;</span>, <span class="string">&quot;fullname&quot;</span>: <span class="string">&quot;Tony Stark&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserBase</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line">    fullname: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserIn</span>(<span class="title class_ inherited__">UserBase</span>):</span><br><span class="line">    password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserOut</span>(<span class="title class_ inherited__">UserBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/users&quot;</span>, status_code=<span class="number">201</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">user: UserIn</span>):</span><br><span class="line">    user_dict = user.model_dump()</span><br><span class="line">    user_dict.update(&#123;<span class="string">&quot;id&quot;</span>: <span class="number">6</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> user_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;username&#125;&quot;</span>, status_code=<span class="number">200</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">username: <span class="built_in">str</span> = Path(<span class="params">..., min_length=<span class="number">1</span></span>)</span>):</span><br><span class="line">    user = users.get(username, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line">    <span class="keyword">raise</span> HTTPException(status_code=status.HTTP_404_NOT_FOUND, detail=<span class="string">f&quot;<span class="subst">&#123;username&#125;</span> not found&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707413131989-2c0ed914-de13-455c-a70c-810b078ed1dc.png"></p>
<h3 id="自定义异常"><a href="#自定义异常" class="headerlink" title="自定义异常"></a>自定义异常</h3><ul>
<li>通过使用<code>@app.exception_handler()</code>进行异常处理</li>
<li>通过<code>JSONResponse</code>返回异常结果</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path, HTTPException, status, Request</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> JSONResponse</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">users = &#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;a&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;b&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;bbb&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;c&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;c&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ccc&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;default&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;d&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">4</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;d&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ddd&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user d&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;e&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">5</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;e&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;eee&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user e&quot;</span>, <span class="string">&quot;fullname&quot;</span>: <span class="string">&quot;Tony Stark&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserBase</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line">    fullname: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserIn</span>(<span class="title class_ inherited__">UserBase</span>):</span><br><span class="line">    password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserOut</span>(<span class="title class_ inherited__">UserBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserNotFoundException</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, username: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.username = username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/users&quot;</span>, status_code=<span class="number">201</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">user: UserIn</span>):</span><br><span class="line">    user_dict = user.model_dump()</span><br><span class="line">    user_dict.update(&#123;<span class="string">&quot;id&quot;</span>: <span class="number">6</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> user_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;username&#125;&quot;</span>, status_code=<span class="number">200</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">username: <span class="built_in">str</span> = Path(<span class="params">..., min_length=<span class="number">1</span></span>)</span>):</span><br><span class="line">    user = users.get(username, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line">    <span class="keyword">raise</span> UserNotFoundException(username)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception_handler(<span class="params">UserNotFoundException</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">user_not_found_exception_handler</span>(<span class="params">request: Request, exc: UserNotFoundException</span>):</span><br><span class="line">    <span class="keyword">return</span> JSONResponse(status_code=<span class="number">404</span>,</span><br><span class="line">                        content=&#123;</span><br><span class="line">                            <span class="string">&quot;error_code&quot;</span>: <span class="number">404</span>,</span><br><span class="line">                            <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;user: <span class="subst">&#123;exc.username&#125;</span> not found&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707413765023-e619af15-7030-472e-91e8-002514b1f77a.png"></p>
<h3 id="处理多种返回"><a href="#处理多种返回" class="headerlink" title="处理多种返回"></a>处理多种返回</h3><ul>
<li>通过<code>responses=</code>参数指定会包含的多种异常返回响应模型<ul>
<li>但是这块需要注意一点：responses 中的异常响应模型，并不会对 return 的内容做格式化，所以需要自己处理一下返回的内容</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Path, HTTPException, status, Request</span><br><span class="line"><span class="keyword">from</span> fastapi.responses <span class="keyword">import</span> JSONResponse</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line">users = &#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">1</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;a&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">2</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;b&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;bbb&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;c&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;c&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ccc&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;default&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;d&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">4</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;d&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;ddd&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user d&quot;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;e&quot;</span>: &#123;<span class="string">&quot;id&quot;</span>: <span class="number">5</span>, <span class="string">&quot;username&quot;</span>: <span class="string">&quot;e&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;eee&quot;</span>, <span class="string">&quot;description&quot;</span>: <span class="string">&quot;it&#x27;s user e&quot;</span>, <span class="string">&quot;fullname&quot;</span>: <span class="string">&quot;Tony Stark&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserBase</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="literal">None</span></span><br><span class="line">    username: <span class="built_in">str</span></span><br><span class="line">    description: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="string">&quot;default&quot;</span></span><br><span class="line">    fullname: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserIn</span>(<span class="title class_ inherited__">UserBase</span>):</span><br><span class="line">    password: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserOut</span>(<span class="title class_ inherited__">UserBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ErrorMessage</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    error_code: <span class="built_in">int</span></span><br><span class="line">    message: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserNotFoundException</span>(<span class="title class_ inherited__">Exception</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, username: <span class="built_in">str</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.username = username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/users&quot;</span>, status_code=<span class="number">201</span>, response_model=UserOut, responses=&#123;</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="number">400</span>: &#123;</span></span></span><br><span class="line"><span class="params"><span class="meta">        <span class="string">&quot;model&quot;</span>: ErrorMessage,</span></span></span><br><span class="line"><span class="params"><span class="meta">    &#125;,</span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="number">401</span>: &#123;</span></span></span><br><span class="line"><span class="params"><span class="meta">        <span class="string">&quot;model&quot;</span>: ErrorMessage,</span></span></span><br><span class="line"><span class="params"><span class="meta">    &#125;</span></span></span><br><span class="line"><span class="params"><span class="meta">&#125;</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_user</span>(<span class="params">user: UserIn</span>):</span><br><span class="line">    <span class="keyword">if</span> users.get(user.username, <span class="literal">None</span>):</span><br><span class="line">        error_message = ErrorMessage(error_code=<span class="number">400</span>, message=<span class="string">f&quot;user: <span class="subst">&#123;user.username&#125;</span> already exists&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> JSONResponse(status_code=status.HTTP_400_BAD_REQUEST, content=error_message.model_dump())</span><br><span class="line">    user_dict = user.model_dump()</span><br><span class="line">    user_dict.update(&#123;<span class="string">&quot;id&quot;</span>: <span class="number">6</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> user_dict</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users/&#123;username&#125;&quot;</span>, status_code=<span class="number">200</span>, response_model=UserOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_user</span>(<span class="params">username: <span class="built_in">str</span> = Path(<span class="params">..., min_length=<span class="number">1</span></span>)</span>):</span><br><span class="line">    user = users.get(username, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> user:</span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line">    <span class="keyword">raise</span> UserNotFoundException(username)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.exception_handler(<span class="params">UserNotFoundException</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">user_not_found_exception_handler</span>(<span class="params">request: Request, exc: UserNotFoundException</span>):</span><br><span class="line">    <span class="keyword">return</span> JSONResponse(status_code=<span class="number">404</span>,</span><br><span class="line">                        content=&#123;</span><br><span class="line">                            <span class="string">&quot;error_code&quot;</span>: <span class="number">404</span>,</span><br><span class="line">                            <span class="string">&quot;message&quot;</span>: <span class="string">f&quot;user: <span class="subst">&#123;exc.username&#125;</span> not found&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这会儿看结果就会有响应模型 400、401 的</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707414563542-a0c93efe-0efd-4de7-b5f2-fcb5c7b7a1d6.png"></p>
<p>同时重复创建用户的话</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707414614798-7aa31869-8b89-4e05-8d98-d29f3cd56e5d.png"></p>
<h1 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h1><ul>
<li>依赖注入用于对依赖项的参数进行调用&#x2F;引用，便于代码的复用，如分页功能</li>
</ul>
<p>创建一个<code>/depends</code>目录，然后在下面创建<code>main.py</code></p>
<h2 id="函数作为依赖项"><a href="#函数作为依赖项" class="headerlink" title="函数作为依赖项"></a>函数作为依赖项</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pageinfo_params</span>(<span class="params">page_index: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span>, page_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">10</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;page_index&quot;</span>: page_index, <span class="string">&quot;page_size&quot;</span>: page_size&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_items</span>(<span class="params">page_info: <span class="built_in">dict</span> = Depends(<span class="params">pageinfo_params</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> page_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_users</span>(<span class="params">page_info: <span class="built_in">dict</span> = Depends(<span class="params">pageinfo_params</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> page_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707415487646-90251fe1-f485-4157-bcb0-e66fb4b4402f.png"></p>
<h2 id="类作为依赖项"><a href="#类作为依赖项" class="headerlink" title="类作为依赖项"></a>类作为依赖项</h2><ul>
<li>类作为依赖项时，以下两个表达效果一致<ul>
<li><code>page_info: PageInfo = Depends(PageInfo)</code></li>
<li><code>page_info: PageInfo = Depends()</code></li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pageinfo_params</span>(<span class="params">page_index: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span>, page_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">10</span></span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;page_index&quot;</span>: page_index, <span class="string">&quot;page_size&quot;</span>: page_size&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PageInfo</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, page_index: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span>, page_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">10</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.page_index = page_index</span><br><span class="line">        <span class="variable language_">self</span>.page_size = page_size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_items</span>(<span class="params">page_info: <span class="built_in">dict</span> = Depends(<span class="params">pageinfo_params</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> page_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_users</span>(<span class="params">page_info: PageInfo = Depends(<span class="params">PageInfo</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> page_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="子依赖项"><a href="#子依赖项" class="headerlink" title="子依赖项"></a>子依赖项</h2><p>子依赖项其实就是 依赖项中某项具有依赖项</p>
<p>增加一个总页码的项</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">total_pages_params</span>(<span class="params">total_page: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">return</span> total_page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pageinfo_params</span>(<span class="params">page_index: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span>, page_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">10</span>,</span></span><br><span class="line"><span class="params">                    total: <span class="type">Optional</span>[<span class="built_in">int</span>] = Depends(<span class="params">total_pages_params</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;page_index&quot;</span>: page_index, <span class="string">&quot;page_size&quot;</span>: page_size, <span class="string">&quot;total&quot;</span>: total&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PageInfo</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, page_index: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span>, page_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">10</span>,</span></span><br><span class="line"><span class="params">                 total: <span class="type">Optional</span>[<span class="built_in">int</span>] = Depends(<span class="params">total_pages_params</span>)</span>):</span><br><span class="line">        <span class="variable language_">self</span>.page_index = page_index</span><br><span class="line">        <span class="variable language_">self</span>.page_size = page_size</span><br><span class="line">        <span class="variable language_">self</span>.total = total</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_items</span>(<span class="params">page_info: <span class="built_in">dict</span> = Depends(<span class="params">pageinfo_params</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> page_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_users</span>(<span class="params">page_info: PageInfo = Depends(<span class="params">PageInfo</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> page_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707416127796-fa634dd4-bdba-40e1-9eda-d42a4fea7e49.png"></p>
<h2 id="通过依赖注解使用-dependencies"><a href="#通过依赖注解使用-dependencies" class="headerlink" title="通过依赖注解使用 dependencies"></a>通过依赖注解使用 dependencies</h2><p>给 get_users 加上一个鉴权的功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends, Header, HTTPException</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">auth_verify</span>(<span class="params">api_token: <span class="type">Optional</span>[<span class="built_in">str</span>] = Header(<span class="params">default=<span class="literal">None</span>, alias=<span class="string">&quot;api-token&quot;</span></span>)</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> api_token:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">401</span>, detail=<span class="string">&quot;No API token provided,Unauthorized&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">total_pages_params</span>(<span class="params">total_page: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">return</span> total_page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pageinfo_params</span>(<span class="params">page_index: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span>, page_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">10</span>,</span></span><br><span class="line"><span class="params">                    total: <span class="type">Optional</span>[<span class="built_in">int</span>] = Depends(<span class="params">total_pages_params</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;page_index&quot;</span>: page_index, <span class="string">&quot;page_size&quot;</span>: page_size, <span class="string">&quot;total&quot;</span>: total&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PageInfo</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, page_index: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span>, page_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">10</span>,</span></span><br><span class="line"><span class="params">                 total: <span class="type">Optional</span>[<span class="built_in">int</span>] = Depends(<span class="params">total_pages_params</span>)</span>):</span><br><span class="line">        <span class="variable language_">self</span>.page_index = page_index</span><br><span class="line">        <span class="variable language_">self</span>.page_size = page_size</span><br><span class="line">        <span class="variable language_">self</span>.total = total</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_items</span>(<span class="params">page_info: <span class="built_in">dict</span> = Depends(<span class="params">pageinfo_params</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> page_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span>, dependencies=[Depends(<span class="params">auth_verify</span>)]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_users</span>(<span class="params">page_info: PageInfo = Depends(<span class="params">PageInfo</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> page_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707416843600-2f9e01ae-9aff-4efa-99a2-95ac473f101f.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707416858120-a773d67f-0797-488c-934b-ca2fc108b622.png"></p>
<h2 id="全局依赖注入"><a href="#全局依赖注入" class="headerlink" title="全局依赖注入"></a>全局依赖注入</h2><p>如果不只是 get_user 需要鉴权，所有 api 都需要鉴权，这是可以在构造 app 的时候传入 dependencies</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Optional</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends, Header, HTTPException</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">auth_verify</span>(<span class="params">api_token: <span class="type">Optional</span>[<span class="built_in">str</span>] = Header(<span class="params">default=<span class="literal">None</span>, alias=<span class="string">&quot;api-token&quot;</span></span>)</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> api_token:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">401</span>, detail=<span class="string">&quot;No API token provided,Unauthorized&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI(dependencies=[Depends(auth_verify)])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">total_pages_params</span>(<span class="params">total_page: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">return</span> total_page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pageinfo_params</span>(<span class="params">page_index: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span>, page_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">10</span>,</span></span><br><span class="line"><span class="params">                    total: <span class="type">Optional</span>[<span class="built_in">int</span>] = Depends(<span class="params">total_pages_params</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;page_index&quot;</span>: page_index, <span class="string">&quot;page_size&quot;</span>: page_size, <span class="string">&quot;total&quot;</span>: total&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PageInfo</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, page_index: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">1</span>, page_size: <span class="type">Optional</span>[<span class="built_in">int</span>] = <span class="number">10</span>,</span></span><br><span class="line"><span class="params">                 total: <span class="type">Optional</span>[<span class="built_in">int</span>] = Depends(<span class="params">total_pages_params</span>)</span>):</span><br><span class="line">        <span class="variable language_">self</span>.page_index = page_index</span><br><span class="line">        <span class="variable language_">self</span>.page_size = page_size</span><br><span class="line">        <span class="variable language_">self</span>.total = total</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_items</span>(<span class="params">page_info: <span class="built_in">dict</span> = Depends(<span class="params">pageinfo_params</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> page_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_users</span>(<span class="params">page_info: PageInfo = Depends(<span class="params">PageInfo</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> page_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707417048757-7b8d825b-ea8f-4a99-887c-70cb899545ca.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707417054185-859dd14a-4b2d-4c79-a5f9-cdc81ddcddaf.png"></p>
<h1 id="API-的身份认证"><a href="#API-的身份认证" class="headerlink" title="API 的身份认证"></a>API 的身份认证</h1><h2 id="插件准备"><a href="#插件准备" class="headerlink" title="插件准备"></a>插件准备</h2><ul>
<li><code>python-multipart==0.0.6</code></li>
<li><code>PyJWT==2.8.0</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fastapi[all]</span><br><span class="line">python-multipart==0.0.6</span><br><span class="line">PyJWT==2.8.0</span><br></pre></td></tr></table></figure>

<h2 id="用户登录的-API"><a href="#用户登录的-API" class="headerlink" title="用户登录的 API"></a>用户登录的 API</h2><p>创建一个目录<code>/security</code>然后创建一个<code>main.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timezone, timedelta</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends, HTTPException</span><br><span class="line"><span class="keyword">from</span> fastapi.security <span class="keyword">import</span> OAuth2PasswordBearer, OAuth2PasswordRequestForm</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"></span><br><span class="line">SECURITY_KEY = <span class="string">&quot;zacharysecret&quot;</span></span><br><span class="line">ALGORITHMS = <span class="string">&quot;HS256&quot;</span></span><br><span class="line">oauth2_scheme = OAuth2PasswordBearer(tokenUrl=<span class="string">&quot;/token&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Token</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    access_token: <span class="built_in">str</span></span><br><span class="line">    token_type: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_user</span>(<span class="params">username: <span class="built_in">str</span>, password: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">if</span> username == <span class="string">&quot;zachary&quot;</span> <span class="keyword">and</span> password == <span class="string">&quot;123456&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> username</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_current_user</span>(<span class="params">token: <span class="built_in">str</span> = Depends(<span class="params">oauth2_scheme</span>)</span>):</span><br><span class="line">    unauth_exp = HTTPException(status_code=<span class="number">401</span>, detail=<span class="string">&quot;Unauthorized&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        username = <span class="literal">None</span></span><br><span class="line">        token_data = jwt.decode(token, SECURITY_KEY, ALGORITHMS)</span><br><span class="line">        <span class="keyword">if</span> token_data:</span><br><span class="line">            username = token_data.get(<span class="string">&quot;username&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">raise</span> unauth_exp</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">        <span class="keyword">raise</span> unauth_exp</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/token&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">login_form: OAuth2PasswordRequestForm = Depends(<span class="params"></span>)</span>):</span><br><span class="line">    username = validate_user(login_form.username, login_form.password)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">401</span>, detail=<span class="string">&quot;Incorrect username or password&quot;</span>,</span><br><span class="line">                            headers=&#123;<span class="string">&quot;WWW-Authenticate&quot;</span>: <span class="string">&quot;Bearer&quot;</span>&#125;)</span><br><span class="line">    token_expires = datetime.now(timezone.utc) + timedelta(minutes=<span class="number">30</span>)</span><br><span class="line">    token_data = &#123;<span class="string">&quot;username&quot;</span>: username, <span class="string">&quot;exp&quot;</span>: token_expires&#125;</span><br><span class="line"></span><br><span class="line">    token = jwt.encode(token_data, SECURITY_KEY, ALGORITHMS)</span><br><span class="line">    <span class="keyword">return</span> Token(access_token=token, token_type=<span class="string">&quot;bearer&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/items&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_items</span>(<span class="params">username: <span class="built_in">str</span> = Depends(<span class="params">get_current_user</span>)</span>):</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;current_user&quot;</span>: username&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707419077885-f3f421bc-91d9-48a6-89d5-62fbf98a0f30.png"></p>
<p>可以点击小锁头 先进行一个登录</p>
<p>然后再实现需要登录的 api</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707419212468-c6af1473-be92-43bc-ae42-7db93a1961ec.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707419215956-67b9085d-d7a8-44e6-ac82-3a748d5992d4.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707419221433-f370ecaf-378d-41f0-99e7-ee1ae5ebeb07.png"></p>
<h1 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h1><h2 id="插件准备-1"><a href="#插件准备-1" class="headerlink" title="插件准备"></a>插件准备</h2><ul>
<li><code>mysqlclient</code></li>
<li><code>SQLAlchemy</code></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fastapi[all]</span><br><span class="line">python-multipart==0.0.6</span><br><span class="line">PyJWT==2.8.0</span><br><span class="line">mysqlclient==2.1.1</span><br><span class="line">SQLAlchemy==2.0.23</span><br></pre></td></tr></table></figure>

<h2 id="定义数据库表映射类"><a href="#定义数据库表映射类" class="headerlink" title="定义数据库表映射类"></a>定义数据库表映射类</h2><p>创建一个<code>/db_process</code>目录，然后创建一个<code>main.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Integer, String</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> DeclarativeBase, Mapped, mapped_column, sessionmaker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span>(<span class="title class_ inherited__">DeclarativeBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&quot;mysql+mysqldb://root:980226@localhost:3306/testApi&quot;</span>, echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义数据库映射类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentEntity</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&quot;students&quot;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[<span class="built_in">int</span>] = mapped_column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name: Mapped[<span class="built_in">str</span>] = mapped_column(String(<span class="number">128</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    gender: Mapped[<span class="built_in">str</span>] = mapped_column(String(<span class="number">10</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义API内容</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>如果现在运行一下这个代码，就会生成 students 这张表</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707421041848-6b3e99ab-b2dd-4e40-b137-8408aeb88f2d.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707421065251-6c28ff1a-a450-4ff3-8aa3-798edbd65f44.png">运行后</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707421097785-130041d9-36d8-4546-8dfa-6f2b6f4f6a0d.png"></p>
<h2 id="准备-API-的输入输出-schema-类"><a href="#准备-API-的输入输出-schema-类" class="headerlink" title="准备 API 的输入输出 schema 类"></a>准备 API 的输入输出 schema 类</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment"># 定义API模型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentBase</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    gender: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentCreate</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentOut</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br></pre></td></tr></table></figure>

<h2 id="准备用户数据库连接的-depends-依赖项"><a href="#准备用户数据库连接的-depends-依赖项" class="headerlink" title="准备用户数据库连接的 depends 依赖项"></a>准备用户数据库连接的 depends 依赖项</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_bd_session</span>():</span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> session</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br></pre></td></tr></table></figure>

<h2 id="创建和查看所有用户-API"><a href="#创建和查看所有用户-API" class="headerlink" title="创建和查看所有用户 API"></a>创建和查看所有用户 API</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends, HTTPException</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Integer, String, select, asc</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> DeclarativeBase, Mapped, mapped_column, sessionmaker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span>(<span class="title class_ inherited__">DeclarativeBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&quot;mysql+mysqldb://root:980226@localhost:3306/testApi&quot;</span>, echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义数据库映射类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentEntity</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&quot;students&quot;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[<span class="built_in">int</span>] = mapped_column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name: Mapped[<span class="built_in">str</span>] = mapped_column(String(<span class="number">128</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    gender: Mapped[<span class="built_in">str</span>] = mapped_column(String(<span class="number">10</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义API模型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentBase</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    gender: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentCreate</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentOut</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_bd_session</span>():</span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> session</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&#x27;/students&#x27;</span>, response_model=StudentOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_student</span>(<span class="params">student: StudentCreate, db_session: Session = Depends(<span class="params">get_bd_session</span>)</span>):</span><br><span class="line">    query = select(StudentEntity).where(StudentEntity.name == student.name)</span><br><span class="line">    result = db_session.execute(query).scalars().<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">f&quot;该学生(<span class="subst">&#123;student.name&#125;</span>)已存在&quot;</span>)</span><br><span class="line"></span><br><span class="line">    student = StudentEntity(name=student.name, gender=student.gender)</span><br><span class="line">    db_session.add(student)</span><br><span class="line">    db_session.commit()</span><br><span class="line">    <span class="keyword">return</span> student</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&#x27;/students&#x27;</span>, response_model=<span class="type">List</span>[StudentOut]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_students</span>(<span class="params">db_session: Session = Depends(<span class="params">get_bd_session</span>)</span>):</span><br><span class="line">    query = select(StudentEntity).order_by(asc(StudentEntity.name))</span><br><span class="line">    <span class="keyword">return</span> db_session.execute(query).scalars().<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>创建一个不存在的用户：成功</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707422311208-d0f91372-6412-48c6-8024-4013eb6fdfa1.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707422337029-8d9f600c-1c90-4606-b969-07147901d691.png"></p>
<p>查看所有学生列表：成功</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707422382141-228e4281-9581-41b4-bc26-1cb459805c5d.png"></p>
<p>创建一个已经存在的学生：异常</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707422411346-a70623a9-0b58-4a2a-813f-9db973b2e5f8.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707422431330-37d4b304-37ce-47c2-b8e1-5d5991a2f247.png"></p>
<h1 id="实现更新与删除"><a href="#实现更新与删除" class="headerlink" title="实现更新与删除"></a>实现更新与删除</h1><p>在<code>/db_process/main.py</code>中做修改</p>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends, HTTPException, Path</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Integer, String, select, asc</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> DeclarativeBase, Mapped, mapped_column, sessionmaker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span>(<span class="title class_ inherited__">DeclarativeBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&quot;mysql+mysqldb://root:980226@localhost:3306/testApi&quot;</span>, echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义数据库映射类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentEntity</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&quot;students&quot;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[<span class="built_in">int</span>] = mapped_column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name: Mapped[<span class="built_in">str</span>] = mapped_column(String(<span class="number">128</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    gender: Mapped[<span class="built_in">str</span>] = mapped_column(String(<span class="number">10</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义API模型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentBase</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    gender: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentCreate</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentUpdate</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentOut</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_bd_session</span>():</span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> session</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&#x27;/students&#x27;</span>, response_model=StudentOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_student</span>(<span class="params">student: StudentCreate, db_session: Session = Depends(<span class="params">get_bd_session</span>)</span>):</span><br><span class="line">    query = select(StudentEntity).where(StudentEntity.name == student.name)</span><br><span class="line">    result = db_session.execute(query).scalars().<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">f&quot;该学生(<span class="subst">&#123;student.name&#125;</span>)已存在&quot;</span>)</span><br><span class="line"></span><br><span class="line">    student = StudentEntity(name=student.name, gender=student.gender)</span><br><span class="line">    db_session.add(student)</span><br><span class="line">    db_session.commit()</span><br><span class="line">    <span class="keyword">return</span> student</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&#x27;/students&#x27;</span>, response_model=<span class="type">List</span>[StudentOut]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_students</span>(<span class="params">db_session: Session = Depends(<span class="params">get_bd_session</span>)</span>):</span><br><span class="line">    query = select(StudentEntity).order_by(asc(StudentEntity.name))</span><br><span class="line">    <span class="keyword">return</span> db_session.execute(query).scalars().<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&#x27;/students/&#123;student_id&#125;&#x27;</span>, response_model=StudentOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_student</span>(<span class="params">*, student_id: <span class="built_in">int</span> = Path(<span class="params">...</span>), student: StudentUpdate,</span></span><br><span class="line"><span class="params">                         db_session: Session = Depends(<span class="params">get_bd_session</span>)</span>):</span><br><span class="line">    query = select(StudentEntity).where(StudentEntity.<span class="built_in">id</span> == student_id)</span><br><span class="line">    exist_student = db_session.execute(query).scalar()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> exist_student:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">404</span>, detail=<span class="string">f&quot;该学生(<span class="subst">&#123;student_id&#125;</span>)不存在&quot;</span>)</span><br><span class="line">    exist_student.name = student.name</span><br><span class="line">    exist_student.gender = student.gender</span><br><span class="line">    db_session.commit()</span><br><span class="line">    <span class="keyword">return</span> exist_student</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707423177226-54b19804-376e-4c50-9d1f-863796ff4f09.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707423328489-86c01df3-20e8-4a15-85ac-b01105a108cb.png"></p>
<p>更新已经可以实现了，但是这块仍旧会有些问题：</p>
<ul>
<li>如果 StudentUpdate 有更新的话，就会需要修改字段更新的部分</li>
<li>如果字段比较多的话需要写的内容也比较多</li>
<li>虽然 SQLAlchemy 提供了 update 方法可以直接更新，但是更新的内容不能直接返回，还需要重新查一次数据库才行</li>
</ul>
<p>这块列出三种更新方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">set_attrs</span>(<span class="params">obj, data: <span class="built_in">dict</span></span>):</span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> data.items():</span><br><span class="line">            <span class="built_in">setattr</span>(obj, key, value)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新方法1，缺点：无法直接获取返回的对象，需要再查一次库，优点：很方便</span></span><br><span class="line"><span class="comment"># update_query = update(StudentEntity).where(StudentEntity.id == student_id).values(**student.dict())</span></span><br><span class="line">update_query = update(StudentEntity).where(StudentEntity.<span class="built_in">id</span> == student_id).values(student.model_dump())</span><br><span class="line">db_session.execute(update_query)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新方法2，缺点：如果字段很多，需要一个一个写很麻烦，如果实体类改变字段也需要改 优点：可以直接修改内存中的对象，修改后可以返回</span></span><br><span class="line">exist_student.name = student.name</span><br><span class="line">exist_student.gender = student.gender</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新方法3 优点：可以获取内存中的对象，便于返回；同时如果实体类改变，也会对应修改</span></span><br><span class="line">set_attrs(exist_student, student.<span class="built_in">dict</span>())</span><br></pre></td></tr></table></figure>

<p>完整代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends, HTTPException, Path</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Integer, String, select, asc, update</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> DeclarativeBase, Mapped, mapped_column, sessionmaker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_attrs</span>(<span class="params">obj, data: <span class="built_in">dict</span></span>):</span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> data.items():</span><br><span class="line">            <span class="built_in">setattr</span>(obj, key, value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span>(<span class="title class_ inherited__">DeclarativeBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&quot;mysql+mysqldb://root:980226@localhost:3306/testApi&quot;</span>, echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义数据库映射类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentEntity</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&quot;students&quot;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[<span class="built_in">int</span>] = mapped_column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name: Mapped[<span class="built_in">str</span>] = mapped_column(String(<span class="number">128</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    gender: Mapped[<span class="built_in">str</span>] = mapped_column(String(<span class="number">10</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义API模型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentBase</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    gender: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentCreate</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentUpdate</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentOut</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_bd_session</span>():</span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> session</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&#x27;/students&#x27;</span>, response_model=StudentOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_student</span>(<span class="params">student: StudentCreate, db_session: Session = Depends(<span class="params">get_bd_session</span>)</span>):</span><br><span class="line">    query = select(StudentEntity).where(StudentEntity.name == student.name)</span><br><span class="line">    result = db_session.execute(query).scalars().<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">f&quot;该学生(<span class="subst">&#123;student.name&#125;</span>)已存在&quot;</span>)</span><br><span class="line"></span><br><span class="line">    student = StudentEntity(name=student.name, gender=student.gender)</span><br><span class="line">    db_session.add(student)</span><br><span class="line">    db_session.commit()</span><br><span class="line">    <span class="keyword">return</span> student</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&#x27;/students&#x27;</span>, response_model=<span class="type">List</span>[StudentOut]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_students</span>(<span class="params">db_session: Session = Depends(<span class="params">get_bd_session</span>)</span>):</span><br><span class="line">    query = select(StudentEntity).order_by(asc(StudentEntity.name))</span><br><span class="line">    <span class="keyword">return</span> db_session.execute(query).scalars().<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&#x27;/students/&#123;student_id&#125;&#x27;</span>, response_model=StudentOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_student</span>(<span class="params">*, student_id: <span class="built_in">int</span> = Path(<span class="params">...</span>), student: StudentUpdate,</span></span><br><span class="line"><span class="params">                         db_session: Session = Depends(<span class="params">get_bd_session</span>)</span>):</span><br><span class="line">    query = select(StudentEntity).where(StudentEntity.<span class="built_in">id</span> == student_id)</span><br><span class="line">    exist_student = db_session.execute(query).scalar()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> exist_student:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">404</span>, detail=<span class="string">f&quot;该学生(<span class="subst">&#123;student_id&#125;</span>)不存在&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># # 更新方法1，缺点：无法直接获取返回的对象，需要再查一次库，优点：很方便</span></span><br><span class="line">    <span class="comment"># # update_query = update(StudentEntity).where(StudentEntity.id == student_id).values(**student.dict())</span></span><br><span class="line">    <span class="comment"># update_query = update(StudentEntity).where(StudentEntity.id == student_id).values(student.model_dump())</span></span><br><span class="line">    <span class="comment"># db_session.execute(update_query)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># # 更新方法2，缺点：如果字段很多，需要一个一个写很麻烦，如果实体类改变字段也需要改 优点：可以直接修改内存中的对象，修改后可以返回</span></span><br><span class="line">    <span class="comment"># exist_student.name = student.name</span></span><br><span class="line">    <span class="comment"># exist_student.gender = student.gender</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 更新方法3 优点：可以获取内存中的对象，便于返回；同时如果实体类改变，也会对应修改</span></span><br><span class="line">    set_attrs(exist_student, student.<span class="built_in">dict</span>())</span><br><span class="line"></span><br><span class="line">    db_session.commit()</span><br><span class="line">    <span class="keyword">return</span> exist_student</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, Depends, HTTPException, Path</span><br><span class="line"><span class="keyword">from</span> pydantic <span class="keyword">import</span> BaseModel</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine, Integer, String, select, asc, update</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> DeclarativeBase, Mapped, mapped_column, sessionmaker</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_attrs</span>(<span class="params">obj, data: <span class="built_in">dict</span></span>):</span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> data.items():</span><br><span class="line">            <span class="built_in">setattr</span>(obj, key, value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Base</span>(<span class="title class_ inherited__">DeclarativeBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&quot;mysql+mysqldb://root:980226@localhost:3306/testApi&quot;</span>, echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义数据库映射类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentEntity</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&quot;students&quot;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[<span class="built_in">int</span>] = mapped_column(Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name: Mapped[<span class="built_in">str</span>] = mapped_column(String(<span class="number">128</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    gender: Mapped[<span class="built_in">str</span>] = mapped_column(String(<span class="number">10</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义API模型</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentBase</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name: <span class="built_in">str</span></span><br><span class="line">    gender: <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentCreate</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentUpdate</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StudentOut</span>(<span class="title class_ inherited__">StudentBase</span>):</span><br><span class="line">    <span class="built_in">id</span>: <span class="built_in">int</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_bd_session</span>():</span><br><span class="line">    session = Session()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> session</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        session.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&#x27;/students&#x27;</span>, response_model=StudentOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">create_student</span>(<span class="params">student: StudentCreate, db_session: Session = Depends(<span class="params">get_bd_session</span>)</span>):</span><br><span class="line">    query = select(StudentEntity).where(StudentEntity.name == student.name)</span><br><span class="line">    result = db_session.execute(query).scalars().<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">if</span> result:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">400</span>, detail=<span class="string">f&quot;该学生(<span class="subst">&#123;student.name&#125;</span>)已存在&quot;</span>)</span><br><span class="line"></span><br><span class="line">    student = StudentEntity(name=student.name, gender=student.gender)</span><br><span class="line">    db_session.add(student)</span><br><span class="line">    db_session.commit()</span><br><span class="line">    <span class="keyword">return</span> student</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&#x27;/students&#x27;</span>, response_model=<span class="type">List</span>[StudentOut]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_students</span>(<span class="params">db_session: Session = Depends(<span class="params">get_bd_session</span>)</span>):</span><br><span class="line">    query = select(StudentEntity).order_by(asc(StudentEntity.name))</span><br><span class="line">    <span class="keyword">return</span> db_session.execute(query).scalars().<span class="built_in">all</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_student_exist</span>(<span class="params">student_id: <span class="built_in">int</span>, db_session: Session</span>) -&gt; StudentEntity:</span><br><span class="line">    query = select(StudentEntity).where(StudentEntity.<span class="built_in">id</span> == student_id)</span><br><span class="line">    exist_student = db_session.execute(query).scalar()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> exist_student:</span><br><span class="line">        <span class="keyword">raise</span> HTTPException(status_code=<span class="number">404</span>, detail=<span class="string">f&quot;该学生(<span class="subst">&#123;student_id&#125;</span>)不存在&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> exist_student</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.put(<span class="params"><span class="string">&#x27;/students/&#123;student_id&#125;&#x27;</span>, response_model=StudentOut</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">update_student</span>(<span class="params">*, student_id: <span class="built_in">int</span> = Path(<span class="params">...</span>), student: StudentUpdate,</span></span><br><span class="line"><span class="params">                         db_session: Session = Depends(<span class="params">get_bd_session</span>)</span>):</span><br><span class="line">    exist_student = check_student_exist(student_id, db_session)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># # 更新方法1，缺点：无法直接获取返回的对象，需要再查一次库，优点：很方便</span></span><br><span class="line">    <span class="comment"># # update_query = update(StudentEntity).where(StudentEntity.id == student_id).values(**student.dict())</span></span><br><span class="line">    <span class="comment"># update_query = update(StudentEntity).where(StudentEntity.id == student_id).values(student.model_dump())</span></span><br><span class="line">    <span class="comment"># db_session.execute(update_query)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># # 更新方法2，缺点：如果字段很多，需要一个一个写很麻烦，如果实体类改变字段也需要改 优点：可以直接修改内存中的对象，修改后可以返回</span></span><br><span class="line">    <span class="comment"># exist_student.name = student.name</span></span><br><span class="line">    <span class="comment"># exist_student.gender = student.gender</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 更新方法3 优点：可以获取内存中的对象，便于返回；同时如果实体类改变，也会对应修改</span></span><br><span class="line">    set_attrs(exist_student, student.<span class="built_in">dict</span>())</span><br><span class="line"></span><br><span class="line">    db_session.commit()</span><br><span class="line">    <span class="keyword">return</span> exist_student</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.delete(<span class="params"><span class="string">&#x27;/students/&#123;student_id&#125;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">delete_student</span>(<span class="params">student_id: <span class="built_in">int</span> = Path(<span class="params">...</span>), db_session: Session = Depends(<span class="params">get_bd_session</span>)</span>):</span><br><span class="line">    exist_student = check_student_exist(student_id, db_session)</span><br><span class="line"></span><br><span class="line">    db_session.delete(exist_student)</span><br><span class="line">    db_session.commit()</span><br><span class="line">    <span class="keyword">return</span> exist_student</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707424308639-93cdaa3e-4b2f-491b-9bf3-5275318cdcd9.png"></p>
<h1 id="后台任务"><a href="#后台任务" class="headerlink" title="后台任务"></a>后台任务</h1><h2 id="为什么需要后台任务"><a href="#为什么需要后台任务" class="headerlink" title="为什么需要后台任务"></a>为什么需要后台任务</h2><p>当一个 API 执行任务的时间较长时，调用者不希望一直等待任务完成</p>
<p>创建一个目录<code>/background_task</code>，然后创建一个<code>main.py</code></p>
<h2 id="任务函数"><a href="#任务函数" class="headerlink" title="任务函数"></a>任务函数</h2><ul>
<li>任务函数是一个普通的带参数或者无参数的函数</li>
<li>可以是 async 函数或者普通函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI, BackgroundTasks</span><br><span class="line"></span><br><span class="line">app = FastAPI()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_message</span>(<span class="params">message: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;start sending message: <span class="subst">&#123;message&#125;</span>&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">5</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;finish sending message: <span class="subst">&#123;message&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.post(<span class="params"><span class="string">&quot;/notify&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">send_notification</span>(<span class="params">message: <span class="built_in">str</span>, background_tasks: BackgroundTasks</span>):</span><br><span class="line">    background_tasks.add_task(send_message, message=message)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;message&quot;</span>: <span class="string">f&quot;Sending notification: <span class="subst">&#123;message&#125;</span> in background&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707425151901-85e57af0-d3fa-4f4f-bc34-9786bd12df63.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707425161955-ccf19b5c-215d-44d1-b4e0-ff606af4467a.png"></p>
<h1 id="元数据与文档-URL"><a href="#元数据与文档-URL" class="headerlink" title="元数据与文档 URL"></a>元数据与文档 URL</h1><h2 id="标题、描述和版本信息"><a href="#标题、描述和版本信息" class="headerlink" title="标题、描述和版本信息"></a>标题、描述和版本信息</h2><ul>
<li><code>title</code></li>
<li><code>description</code></li>
<li><code>version</code></li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707425477457-91d642ad-e9d7-43ec-aa74-9e24da6d1e87.png"></p>
<p>目前默认的 swagger-UI 的标题和版本信息都是默认的，没有描述</p>
<p>上面这些内容都可以在构造 app 的时候设置</p>
<p>项目目录下创建一个<code>/metadata_api</code>，然后创建一个<code>main.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI(title=<span class="string">&quot;My API about query&quot;</span>,</span><br><span class="line">              description=<span class="string">&quot;All this API is some query api use to zachary&#x27;s blog&quot;</span>,</span><br><span class="line">              version=<span class="string">&quot;1.0.0&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/books&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_books</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;books&quot;</span>: [<span class="string">&quot;book1&quot;</span>, <span class="string">&quot;book2&quot;</span>, <span class="string">&quot;book3&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_users</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;users&quot;</span>: [<span class="string">&quot;user1&quot;</span>, <span class="string">&quot;user2&quot;</span>, <span class="string">&quot;user3&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707425591522-5d97d68d-a5f7-43a3-956b-fb89102b115e.png"></p>
<h2 id="服务条款与协议信息"><a href="#服务条款与协议信息" class="headerlink" title="服务条款与协议信息"></a>服务条款与协议信息</h2><ul>
<li><code>terms_of_service</code>服务条款</li>
<li><code>contact</code>联系信息<ul>
<li><code>name</code>姓名</li>
<li><code>url</code>连接</li>
<li><code>email</code>邮箱</li>
</ul>
</li>
<li><code>license_info</code>协议信息<ul>
<li><code>name</code>协议名称</li>
<li><code>url</code>协议地址</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">app = FastAPI(title=<span class="string">&quot;My API about query&quot;</span>,</span><br><span class="line">              description=<span class="string">&quot;All this API is some query api use to zachary&#x27;s blog&quot;</span>,</span><br><span class="line">              version=<span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">              terms_of_service=<span class="string">&quot;https://zachary.com&quot;</span>,</span><br><span class="line">              contact=&#123;</span><br><span class="line">                  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;zachary&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://zachary.com&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;email&quot;</span>: <span class="string">&quot;zachary@qq.com&quot;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              license_info=&#123;</span><br><span class="line">                  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Apache 2.0&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://www.apache.org/licenses/LICENSE-2.0.html&quot;</span>,</span><br><span class="line">              &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/books&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_books</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;books&quot;</span>: [<span class="string">&quot;book1&quot;</span>, <span class="string">&quot;book2&quot;</span>, <span class="string">&quot;book3&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_users</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;users&quot;</span>: [<span class="string">&quot;user1&quot;</span>, <span class="string">&quot;user2&quot;</span>, <span class="string">&quot;user3&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707426376829-0be775c8-50b4-4b3b-b778-2be2bc7e063e.png"></p>
<h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><ul>
<li><code>openapi_tags=tags_metadata</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">tags_metadata = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;books&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;All this API for books management&quot;</span>,</span><br><span class="line">        <span class="string">&quot;externalDocs&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Books external docs&quot;</span>,</span><br><span class="line">            <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://www.baidu.com&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;users&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;All this API for users management&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">app = FastAPI(title=<span class="string">&quot;My API about query&quot;</span>,</span><br><span class="line">              description=<span class="string">&quot;All this API is some query api use to zachary&#x27;s blog&quot;</span>,</span><br><span class="line">              version=<span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">              terms_of_service=<span class="string">&quot;https://zachary.com&quot;</span>,</span><br><span class="line">              contact=&#123;</span><br><span class="line">                  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;zachary&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://zachary.com&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;email&quot;</span>: <span class="string">&quot;zachary@qq.com&quot;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              license_info=&#123;</span><br><span class="line">                  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Apache 2.0&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://www.apache.org/licenses/LICENSE-2.0.html&quot;</span>,</span><br><span class="line">              &#125;,</span><br><span class="line">              openapi_tags=tags_metadata)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/books&quot;</span>, tags=[<span class="string">&quot;books&quot;</span>, <span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_books</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;books&quot;</span>: [<span class="string">&quot;book1&quot;</span>, <span class="string">&quot;book2&quot;</span>, <span class="string">&quot;book3&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_users</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;users&quot;</span>: [<span class="string">&quot;user1&quot;</span>, <span class="string">&quot;user2&quot;</span>, <span class="string">&quot;user3&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707426434467-6a5d23d6-2336-4545-a023-130977d43e77.png"></p>
<h2 id="openapiURL"><a href="#openapiURL" class="headerlink" title="openapiURL"></a>openapiURL</h2><p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707426455579-45f8ff2d-2860-4513-8240-e2d0eb4ded4b.png"></p>
<ul>
<li><code>openapi_url=&quot;/api/v1/openapi.json&quot;</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">tags_metadata = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;books&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;All this API for books management&quot;</span>,</span><br><span class="line">        <span class="string">&quot;externalDocs&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Books external docs&quot;</span>,</span><br><span class="line">            <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://www.baidu.com&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;users&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;All this API for users management&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">app = FastAPI(title=<span class="string">&quot;My API about query&quot;</span>,</span><br><span class="line">              description=<span class="string">&quot;All this API is some query api use to zachary&#x27;s blog&quot;</span>,</span><br><span class="line">              version=<span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">              terms_of_service=<span class="string">&quot;https://zachary.com&quot;</span>,</span><br><span class="line">              contact=&#123;</span><br><span class="line">                  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;zachary&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://zachary.com&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;email&quot;</span>: <span class="string">&quot;zachary@qq.com&quot;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              license_info=&#123;</span><br><span class="line">                  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Apache 2.0&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://www.apache.org/licenses/LICENSE-2.0.html&quot;</span>,</span><br><span class="line">              &#125;,</span><br><span class="line">              openapi_tags=tags_metadata,</span><br><span class="line">              openapi_url=<span class="string">&quot;/api/v1/openapi.json&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/books&quot;</span>, tags=[<span class="string">&quot;books&quot;</span>, <span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_books</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;books&quot;</span>: [<span class="string">&quot;book1&quot;</span>, <span class="string">&quot;book2&quot;</span>, <span class="string">&quot;book3&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_users</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;users&quot;</span>: [<span class="string">&quot;user1&quot;</span>, <span class="string">&quot;user2&quot;</span>, <span class="string">&quot;user3&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="文档-URL"><a href="#文档-URL" class="headerlink" title="文档 URL"></a>文档 URL</h2><ul>
<li><code>docs_url=&quot;/xxx&quot;</code></li>
<li><code>redoc_url=&quot;/xxx&quot;</code></li>
<li>如果设置为 None 为禁用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> uvicorn</span><br><span class="line"><span class="keyword">from</span> fastapi <span class="keyword">import</span> FastAPI</span><br><span class="line"></span><br><span class="line">tags_metadata = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;books&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;All this API for books management&quot;</span>,</span><br><span class="line">        <span class="string">&quot;externalDocs&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;description&quot;</span>: <span class="string">&quot;Books external docs&quot;</span>,</span><br><span class="line">            <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://www.baidu.com&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;users&quot;</span>,</span><br><span class="line">        <span class="string">&quot;description&quot;</span>: <span class="string">&quot;All this API for users management&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">app = FastAPI(title=<span class="string">&quot;My API about query&quot;</span>,</span><br><span class="line">              description=<span class="string">&quot;All this API is some query api use to zachary&#x27;s blog&quot;</span>,</span><br><span class="line">              version=<span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">              terms_of_service=<span class="string">&quot;https://zachary.com&quot;</span>,</span><br><span class="line">              contact=&#123;</span><br><span class="line">                  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;zachary&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://zachary.com&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;email&quot;</span>: <span class="string">&quot;zachary@qq.com&quot;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              license_info=&#123;</span><br><span class="line">                  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Apache 2.0&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://www.apache.org/licenses/LICENSE-2.0.html&quot;</span>,</span><br><span class="line">              &#125;,</span><br><span class="line">              openapi_tags=tags_metadata,</span><br><span class="line">              openapi_url=<span class="string">&quot;/api/v1/openapi.json&quot;</span>,</span><br><span class="line">              redoc_url=<span class="string">&quot;/r&quot;</span>,</span><br><span class="line">              docs_url=<span class="string">&quot;/swagger&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/books&quot;</span>, tags=[<span class="string">&quot;books&quot;</span>, <span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_books</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;books&quot;</span>: [<span class="string">&quot;book1&quot;</span>, <span class="string">&quot;book2&quot;</span>, <span class="string">&quot;book3&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.get(<span class="params"><span class="string">&quot;/users&quot;</span>, tags=[<span class="string">&quot;users&quot;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_users</span>():</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;users&quot;</span>: [<span class="string">&quot;user1&quot;</span>, <span class="string">&quot;user2&quot;</span>, <span class="string">&quot;user3&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    uvicorn.run(<span class="string">&quot;main:app&quot;</span>, reload=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707426867289-d6bbab62-371c-4a2a-b6e4-0f7a71a6f47c.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/38881094/1707426909576-540635ef-8619-4908-8f45-b5ceee5bd6e4.png"></p>
<blockquote>
<p>更新: 2024-02-09 05:17:11<br>原文: <a target="_blank" rel="noopener" href="https://www.yuque.com/zacharyblock/cx2om6/ifnigya72ztak2tr">https://www.yuque.com/zacharyblock/cx2om6/ifnigya72ztak2tr</a></p>
</blockquote>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Zachary Block</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://blockzachary.github.io/blog/3889409409/">https://blockzachary.github.io/blog/3889409409/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                
                     <p class="copyright-item">
                         <span>Slogan:</span>
                         <span>Do you believe in <strong>DESTINY</strong>?</span>
                     </p>
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/FastAPI/"># FastAPI</a>
                    
                        <a href="/tags/Python-Web/"># Python Web</a>
                    
                        <a href="/tags/RESTful-API/"># RESTful API</a>
                    
                        <a href="/tags/SQLAlchemy/"># SQLAlchemy</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/blog/1086041718/">FastAPI日志系统</a>
            
            
            <a class="next" rel="next" href="/blog/586091050/">RESTful API</a>
            
        </section>


    </article>
</div>

<script src="/js/clipboard.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var codeBlocks = document.querySelectorAll('article .code pre');

        codeBlocks.forEach(function (codeBlock) {
            var copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.innerText = 'Copy';

            // Check if the code block is in the article content
            if (codeBlock.closest('article')) {
                codeBlock.parentNode.style.position = 'relative';
                codeBlock.parentNode.appendChild(copyButton); // 将按钮添加到 codeBlock 的父节点内

                var isCopying = false;

                copyButton.addEventListener('click', function () {
                    if (!isCopying) {
                        var codeText = codeBlock.innerText;
                        navigator.clipboard.writeText(codeText).then(function () {
                            copyButton.innerText = 'Copied!';
                            isCopying = true;
                            setTimeout(function () {
                                copyButton.innerText = 'Copy';
                                isCopying = false;
                            }, 1500);
                        }).catch(function (err) {
                            console.error('Copy failed', err);
                        });
                    }
                });
            }
        });
    });
</script>

<style>
    .copy-button {
        position: absolute;
        top: 0;
        right: 0;
        background-color: #2d96bd;
        color: #fff;
        border: none;
        border-radius: 10%;
        padding: 5px 10px;
        cursor: pointer;
    }
</style>
            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Zachary Block | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>