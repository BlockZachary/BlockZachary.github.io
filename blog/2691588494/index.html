<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="referrer" content="no-referrer">

    <meta name="author" content="Zachary Block">


    <meta name="subtitle" content="这里是副标题">




<title>SQLAlchemy | Zachary Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    
    <script src="/js/jquery.min.js"></script>
    



    
    
        
    





    <script>
    function searchToggle() {
        const width = $(document.body).width()
        if(width > 479) {
            return;
        }
        const search = $('.search');
        const searchForm = $('.form-search')

        if(!search.hasClass("mobile-search")) {
            search.addClass("mobile-search");
        } else {
            search.removeClass("mobile-search");
        } 
    }

    function search(searchInputEl, formEl, flag) {
        const path = "/" + "search.json"; // 可以在public 下查看这个search.json
        $(formEl).submit(function(e){
            e.preventDefault();
            let target = null
            if(searchInputEl == null) {
                const screenWidth = $(document.body).width();
                target = screenWidth > 479 ? $('#pc-search-input') : $('#mobile-search-input');
                console.log(target);
            } else {
                target = $(searchInputEl)
            }

            if(!flag && target.val() === '') {
                return ;
            }

            $("#u-search").fadeIn(500, function() {
                $("body > .wrapper").addClass("modal-active");

                $.ajax({
                    url: path,
                    dataType: "json",
                    beforeSend: function (xhr) {
                        $input = target.val();
                        $(".form-input").val($input);
                        const loadingBar = $('.search-loading-bar') 
                        loadingBar.css({
                            width:'100%',
                            display: 'block'
                        });
                    },
                    success: function( datas ) {
                        // console.log(datas);
                        const $resultPanel = $(".modal-body")[0];
                        let str = `<ul class="modal-results">`;
                        var keywords = $(".form-input").val().trim().toLowerCase().split(/[\s\-]+/);
                        $resultPanel.innerHTML = "";
                        let hasResult = false
                        let text = `<div class="no-result">找不到与关键词相关的内容....</div>`;

                        if ($(".form-input").val().trim().length <= 0) {
                            // 没有结果
                            $resultPanel.innerHTML = text;
                            return;
                        }
                        datas.forEach(function (data) {
                            var isMatch = true;
                            if (!data.title || data.title.trim() === '') {
                                data.title = "Untitled";
                            }
                            var data_title = data.title.trim().toLowerCase();
                            var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                            var data_url = data.url;
                            var index_title = -1;
                            var index_content = -1;
                            var first_occur = -1;
                            // only match artiles with not empty contents
                            if (data_content !== '') {
                                keywords.forEach(function (keyword, i) {
                                    index_title = data_title.indexOf(keyword);
                                    index_content = data_content.indexOf(keyword);

                                    if (index_title < 0 && index_content < 0) {
                                        isMatch = false;
                                    } else {
                                        hasResult = true
                                        if (index_content < 0) {
                                            index_content = 0;
                                        }
                                        if (i == 0) {
                                            first_occur = index_content;
                                        }
                                    }
                                });
                            } else {
                                isMatch = false;
                            }
                            // show search results
                            if (isMatch) {
                                str += `<li class='result-item'><a href='${data_url}' class='result-item-detail'> <span class="title">${data_title}</span>`;
                                var content = data.content.trim().replace(/<[^>]+>/g, "");
                                if (first_occur >= 0) {
                                    // cut out 200 characters
                                    var start = first_occur - 40;
                                    var end = first_occur + 160;

                                    if (start < 0) {
                                        start = 0;
                                    }

                                    if (start == 0) {
                                        end = 200;
                                    }

                                    if (end > content.length) {
                                        end = content.length;
                                    }

                                    var match_content = content.substring(start, end);

                                    // highlight all keywords
                                    keywords.forEach(function (keyword) {
                                        var regS = new RegExp(keyword, "gi");
                                        match_content = match_content.replace(regS, `<em class="search-keyword">${keyword}</em>`);
                                    });

                                    str += `<span class="content"> ${match_content} ...</span></a>`;
                                }
                                str += "</li>";
                            }
                        });
                        str += "</ul>";
                        if(hasResult) {
                            $resultPanel.innerHTML = str;
                        } else {
                            $resultPanel.innerHTML = text;
                        }

                    },
                    complete: function() {
                        setTimeout(() => {
                                const loadingBar = $('.search-loading-bar') 
                                loadingBar.css({
                                    width:'0%',
                                    display: 'none'
                                });
                        }, 300)
                    }
                });
            })

        });
    }

    $(document).ready(function() {
        $('.modal-close').click(function () { 
            $("#u-search").fadeOut();
            $("body > .wrapper").removeClass("modal-active")
        })

        $('.modal-overlay').click(function() {
            $("#u-search").fadeOut();
            $("body > .wrapper").removeClass("modal-active")
        })
        search(null, ".form-search", false)
        search("#u-search-modal-form .form-input", ".u-search-modal-form", true)
    })
</script>

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Zachary Blog" type="application/atom+xml">
</head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Zachary&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                
    <div class="search ">
        <div class="search-btn" onClick="searchToggle()">
            <!-- <img src="/" class="search-btn-img" /> -->
            <i class="iconfont icon-search " ></i>
        </div>
        <form class="form-search">
            <input class="input" placeholder="搜索内容" autocomplete="off" id="pc-search-input"/>
        </form>
    </div>

                
                    <a class="menu-item" href="/archives">归档</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Zachary&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="navbar-mobile-right">
                    
                    
    <div class="search ">
        <div class="search-btn" onClick="searchToggle()">
            <!-- <img src="/" class="search-btn-img" /> -->
            <i class="iconfont icon-search " ></i>
        </div>
        <form class="form-search">
            <input class="input" placeholder="搜索内容" autocomplete="off" id="mobile-search-input"/>
        </form>
    </div>

                    <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
                </div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">归档</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">SQLAlchemy</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Zachary Block</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">1 月 16 日&nbsp;&nbsp;3:28:00</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/Python-MySQL/">Python MySQL</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="SQLAlchemy"><a href="#SQLAlchemy" class="headerlink" title="SQLAlchemy"></a>SQLAlchemy</h1><p>一个使用 Python 编写的 SQL 的 ORM（Object-orient-map）工具包，支持 MySQL、SQL Server、sqlite、Oracle</p>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p><code>pip install sqlalchemy</code></p>
<p>若使用的是 MySQL，需要安装<code>pip install mysqlclient</code></p>
<p><a target="_blank" rel="noopener" href="https://docs.sqlalchemy.org/en/20/dialects/mysql.html#module-sqlalchemy.dialects.mysql.mysqldb">https://docs.sqlalchemy.org/en/20/dialects/mysql.html#module-sqlalchemy.dialects.mysql.mysqldb</a></p>
<h1 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h1><h2 id="连接-sqlite"><a href="#连接-sqlite" class="headerlink" title="连接 sqlite"></a>连接 sqlite</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line">engine = create_engine(<span class="string">&#x27;sqlite:///test.db&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">connection = engine.connect()</span><br></pre></td></tr></table></figure>

<h2 id="连接-MySQL"><a href="#连接-MySQL" class="headerlink" title="连接 MySQL"></a>连接 MySQL</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line">engine = create_engine(<span class="string">&#x27;mysql://user:pwd@localhost/tsetdb&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">connection = engine.connect()</span><br></pre></td></tr></table></figure>

<ul>
<li>echo：是用于显示数据库执行的操作</li>
</ul>
<p>先创建一个数据库中的表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span>(</span><br><span class="line">    id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">20</span>),</span><br><span class="line">    age <span class="type">int</span>,</span><br><span class="line">    gender <span class="type">char</span>(<span class="number">1</span>)</span><br><span class="line">)engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>往里面插入一些数据然后：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"></span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>)</span><br><span class="line">conn = engine.connect()</span><br><span class="line"></span><br><span class="line">query = sqlalchemy.text(<span class="string">&quot;select * from user&quot;</span>)</span><br><span class="line">result = conn.execute(query)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">    <span class="built_in">print</span>(row)</span><br><span class="line">conn.close()</span><br><span class="line">engine.dispose()</span><br></pre></td></tr></table></figure>

<h1 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"></span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">meta_data = sqlalchemy.MetaData()</span><br><span class="line"></span><br><span class="line">students = sqlalchemy.Table(</span><br><span class="line">    <span class="string">&#x27;students&#x27;</span>, meta_data,</span><br><span class="line">    sqlalchemy.Column(<span class="string">&#x27;id&#x27;</span>, sqlalchemy.Integer, primary_key=<span class="literal">True</span>),</span><br><span class="line">    sqlalchemy.Column(<span class="string">&#x27;name&#x27;</span>, sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>),</span><br><span class="line">    sqlalchemy.Column(<span class="string">&#x27;age&#x27;</span>, sqlalchemy.Integer, nullable=<span class="literal">False</span>),</span><br><span class="line">    sqlalchemy.Column(<span class="string">&#x27;gender&#x27;</span>, sqlalchemy.String(<span class="number">8</span>), nullable=<span class="literal">False</span>),</span><br><span class="line">    sqlalchemy.Column(<span class="string">&#x27;birthday&#x27;</span>, sqlalchemy.Date, nullable=<span class="literal">False</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">meta_data.create_all(engine)</span><br></pre></td></tr></table></figure>

<ul>
<li>metaData，用于创建映射表的元数据，为了复用 所以提前使用 sqlalchemy 的 MetaDate()声明一个变量</li>
</ul>
<h1 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h1><ul>
<li>普通 SQL 的插入 <code>INSERT INTO table_name values()</code></li>
<li>一次插入一条数据<code>conn.execute(table_name.insert().values())</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">student_insert = students.insert()</span><br><span class="line">insert_value1 = student_insert.values(</span><br><span class="line">    name=<span class="string">&#x27;zachary&#x27;</span>,</span><br><span class="line">    age=<span class="number">18</span>,</span><br><span class="line">    gender=<span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">    birthday=<span class="string">&#x27;2000-01-01&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">insert_value2 = student_insert.values(</span><br><span class="line">    name=<span class="string">&#x27;curry&#x27;</span>,</span><br><span class="line">    age=<span class="number">36</span>,</span><br><span class="line">    gender=<span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">    birthday=<span class="string">&#x27;1980-03-01&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    conn.execute(insert_value1)</span><br><span class="line">    res = conn.execute(insert_value2)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;插入的values2的主键为：<span class="subst">&#123;res.inserted_primary_key&#125;</span>&quot;</span>)</span><br><span class="line">    conn.commit()</span><br></pre></td></tr></table></figure>

<ul>
<li>一次插入多条数据<code>conn.execute(table_name.insert(), student_list)</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">student_list = [</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;jack&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">18</span>, <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span>, <span class="string">&quot;birthday&quot;</span>: <span class="string">&quot;2000-01-01&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;sandy&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">25</span>, <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span>, <span class="string">&quot;birthday&quot;</span>: <span class="string">&quot;1990-05-04&quot;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;lucy&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">35</span>, <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span>, <span class="string">&quot;birthday&quot;</span>: <span class="string">&quot;2002-08-13&quot;</span>&#125;,</span><br><span class="line">]</span><br><span class="line">student_insert = students.insert()</span><br><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    conn.execute(student_insert, student_list)</span><br><span class="line">    conn.commit()</span><br></pre></td></tr></table></figure>

<h1 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h1><h2 id="查询所有记录"><a href="#查询所有记录" class="headerlink" title="查询所有记录"></a>查询所有记录</h2><ul>
<li>普通 SQL 的查询 <code>SELECT * FROM table_name</code></li>
<li>函数查询 <code>table_name.select()</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    query = students.select()</span><br><span class="line">    <span class="comment"># 方法一</span></span><br><span class="line">    result = conn.execute(query)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row[<span class="number">0</span>],end=<span class="string">&quot; &quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(row.name)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 方法二</span></span><br><span class="line">    result = conn.execute(query)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 方法三</span></span><br><span class="line">    result = conn.execute(query)</span><br><span class="line">    result_set = result.fetchall()</span><br><span class="line">    <span class="built_in">print</span>(result_set)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> result_set:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure>

<h2 id="查询一条记录"><a href="#查询一条记录" class="headerlink" title="查询一条记录"></a>查询一条记录</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    query = students.select()</span><br><span class="line">    result = conn.execute(query)</span><br><span class="line">    result_raw = result.fetchone()</span><br><span class="line">    <span class="built_in">print</span>(result_raw)</span><br></pre></td></tr></table></figure>

<h2 id="条件查询"><a href="#条件查询" class="headerlink" title="条件查询"></a>条件查询</h2><ul>
<li>普通 SQL 的条件查询 <code>SELECT * FROM table_name WHERE 条件</code></li>
<li>函数条件查询 <code>table_name.select().where(条件)</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    <span class="comment"># 单条件查询</span></span><br><span class="line">    query = students.select().where(students.c.gender == <span class="string">&#x27;male&#x27;</span>)</span><br><span class="line">    result = conn.execute(query)</span><br><span class="line">    result_raw = result.fetchall()</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> result_raw:</span><br><span class="line">        <span class="built_in">print</span>(item)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 多条件查询</span></span><br><span class="line">    query = students.select().where(students.c.gender == <span class="string">&#x27;male&#x27;</span>).where(students.c.age &gt; <span class="number">20</span>).where(students.c.birthday &lt; <span class="string">&#x27;2000-01-01&#x27;</span>)</span><br><span class="line">    result = conn.execute(query)</span><br><span class="line">    result_raw = result.fetchall()</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> result_raw:</span><br><span class="line">        <span class="built_in">print</span>(item)</span><br></pre></td></tr></table></figure>

<ul>
<li>更复杂的条件查询 引入<code>and_</code>、<code>or_</code>( <code>from sqlalchemy.sql import and_, or_</code> )</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.sql <span class="keyword">import</span> and_, or_</span><br><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    <span class="comment"># 复杂条件查询</span></span><br><span class="line">    query = students.select().where(</span><br><span class="line">        or_(</span><br><span class="line">            students.c.<span class="built_in">id</span> &gt; <span class="number">3</span>,</span><br><span class="line">            and_(</span><br><span class="line">                students.c.gender == <span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">                students.c.age &gt; <span class="number">30</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">    result = conn.execute(query)</span><br><span class="line">    result_set = result.fetchall()</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result_set:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br></pre></td></tr></table></figure>

<h1 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h1><ul>
<li>普通 SQL 的更新数据 <code>UPDATE table_name SET col1=value1, col2=value2 WHERE 条件</code></li>
<li>函数更新数据<ul>
<li>更新所有数据<ul>
<li><code>table_name.update().values()</code></li>
</ul>
</li>
<li>更新部分数据<ul>
<li><code>table_name.update().where(条件).values()</code></li>
<li><code>update(table_name).where(条件).values()</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    update = students.update().where(students.c.<span class="built_in">id</span> == <span class="number">1</span>).values(</span><br><span class="line">        name=<span class="string">&#x27;zacharyBlock&#x27;</span>,</span><br><span class="line">        age=<span class="number">18</span>,</span><br><span class="line">        gender=<span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">        birthday=<span class="string">&#x27;2000-01-01&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">    conn.execute(update)</span><br><span class="line">    conn.commit()</span><br></pre></td></tr></table></figure>

<h1 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h1><ul>
<li>普通 SQL 的删除数据 <code>DELETE FROM table_name WHERE 条件</code></li>
<li>函数删除数据<ul>
<li>删除所有数据<ul>
<li><code>table_name.delete()</code></li>
</ul>
</li>
<li>删除部分数据<ul>
<li><code>table_name.delete().where(条件)</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    delete = students.delete().where(students.c.<span class="built_in">id</span> == <span class="number">5</span>)</span><br><span class="line">    conn.execute(delete)</span><br><span class="line">    conn.commit()</span><br></pre></td></tr></table></figure>

<h1 id="关联表"><a href="#关联表" class="headerlink" title="关联表"></a>关联表</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>这里举例一个简单的一对多关联表</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/jpeg/38881094/1705517930472-0638ada4-aea4-4e42-b795-5c1d85e574a6.jpeg" alt="画板"></p>
<p>删掉之前的 students 表重新建立一个</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"></span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">meta_data = sqlalchemy.MetaData()</span><br><span class="line"></span><br><span class="line">students = sqlalchemy.Table(</span><br><span class="line">    <span class="string">&#x27;students&#x27;</span>, meta_data,</span><br><span class="line">    sqlalchemy.Column(<span class="string">&#x27;id&#x27;</span>, sqlalchemy.Integer, primary_key=<span class="literal">True</span>),</span><br><span class="line">    sqlalchemy.Column(<span class="string">&#x27;name&#x27;</span>, sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>),</span><br><span class="line">    sqlalchemy.Column(<span class="string">&#x27;age&#x27;</span>, sqlalchemy.Integer, nullable=<span class="literal">False</span>),</span><br><span class="line">    sqlalchemy.Column(<span class="string">&#x27;gender&#x27;</span>, sqlalchemy.String(<span class="number">8</span>), nullable=<span class="literal">False</span>),</span><br><span class="line">    sqlalchemy.Column(<span class="string">&#x27;class_id&#x27;</span>, sqlalchemy.Integer, sqlalchemy.ForeignKey(<span class="string">&#x27;classes.id&#x27;</span>), nullable=<span class="literal">False</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">classes = sqlalchemy.Table(</span><br><span class="line">    <span class="string">&#x27;classes&#x27;</span>, meta_data,</span><br><span class="line">    sqlalchemy.Column(<span class="string">&#x27;id&#x27;</span>, sqlalchemy.Integer, primary_key=<span class="literal">True</span>),</span><br><span class="line">    sqlalchemy.Column(<span class="string">&#x27;name&#x27;</span>, sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">meta_data.create_all(engine)</span><br></pre></td></tr></table></figure>

<p>插入一些数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># insert data</span></span><br><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    conn.execute(classes.insert(), [</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Python&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Java&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Go&quot;</span>&#125;,</span><br><span class="line">    ])</span><br><span class="line">    conn.execute(students.insert(), [</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;zachary&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">18</span>, <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span>, <span class="string">&quot;class_id&quot;</span>: <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;curry&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">36</span>, <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span>, <span class="string">&quot;class_id&quot;</span>: <span class="number">1</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;jack&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">18</span>, <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span>, <span class="string">&quot;class_id&quot;</span>: <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;sandy&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">25</span>, <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span>, <span class="string">&quot;class_id&quot;</span>: <span class="number">2</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;lucy&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">35</span>, <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span>, <span class="string">&quot;class_id&quot;</span>: <span class="number">3</span>&#125;,</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    conn.commit()</span><br></pre></td></tr></table></figure>

<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><ul>
<li>查询 Python 班级的所有学生的信息及班级信息</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    join = students.join(classes, students.c.class_id == classes.c.<span class="built_in">id</span>)</span><br><span class="line">    query = sqlalchemy.select(join).where(classes.c.name == <span class="string">&quot;Python&quot;</span>)</span><br><span class="line">    result = conn.execute(query)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br></pre></td></tr></table></figure>

<ul>
<li>查询 Python 班级的所有学生的信息</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    join = students.join(classes, students.c.class_id == classes.c.<span class="built_in">id</span>)</span><br><span class="line">    <span class="comment"># query = sqlalchemy.select(students).select_from(join).where(classes.c.name == &#x27;Python&#x27;)</span></span><br><span class="line">    query = students.select().select_from(join).where(classes.c.name == <span class="string">&#x27;Python&#x27;</span>)</span><br><span class="line">    result = conn.execute(query)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">        <span class="built_in">print</span>(row)</span><br></pre></td></tr></table></figure>

<ul>
<li>查找 curry 所在的班级</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> engine.connect() <span class="keyword">as</span> conn:</span><br><span class="line">    join = students.join(classes, students.c.class_id == classes.c.<span class="built_in">id</span>)</span><br><span class="line">    <span class="comment"># query = sqlalchemy.select(classes).select_from(join).where(students.c.name == &#x27;curry&#x27;)</span></span><br><span class="line">    query = classes.select().select_from(join).where(students.c.name == <span class="string">&#x27;curry&#x27;</span>)</span><br><span class="line">    result = conn.execute(query)</span><br><span class="line">    <span class="built_in">print</span>(result.fetchall())</span><br></pre></td></tr></table></figure>

<h1 id="映射类-这块如果讲的话-暂时不要带上-join"><a href="#映射类-这块如果讲的话-暂时不要带上-join" class="headerlink" title="映射类(这块如果讲的话 暂时不要带上 join)"></a>映射类(这块如果讲的话 暂时不要带上 join)</h1><p>在 Python 中定义一个类，其中的属性对应着数据表中的字段，通过类对象进行操作从而达到操作数据表的目的</p>
<h2 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h2><ul>
<li>映射类基类</li>
</ul>
<p>通过使用<code>from sqlalchemy.ext.declarative import declarative_base</code>的</p>
<p><code>Base = declarative_base()</code></p>
<p>还是得先删除掉原先创建的 students 表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"></span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">    <span class="built_in">id</span> = sqlalchemy.Column(sqlalchemy.Integer, primary_key=<span class="literal">True</span>)</span><br><span class="line">    name = sqlalchemy.Column(sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    age = sqlalchemy.Column(sqlalchemy.Integer, nullable=<span class="literal">False</span>)</span><br><span class="line">    gender = sqlalchemy.Column(sqlalchemy.String(<span class="number">8</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 若没有创建表 使用Base的metadata创建表</span></span><br><span class="line">Base.metadata.create_all(engine)</span><br></pre></td></tr></table></figure>

<h2 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h2><ul>
<li>通过<code>session</code>添加记录，代替了之前的 connection</li>
<li>添加一条数据 <code>session.add(obj)</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给Session绑定engine</span></span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">session = Session()</span><br><span class="line">student = Student(name=<span class="string">&#x27;Tony&#x27;</span>, age=<span class="number">18</span>, gender=<span class="string">&#x27;male&#x27;</span>)</span><br><span class="line">session.add(student)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<ul>
<li>添加多条数据 <code>session.add_all(list)</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给Session绑定engine</span></span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">session = Session()</span><br><span class="line"><span class="comment"># 添加多条记录</span></span><br><span class="line">student_list = [</span><br><span class="line">    Student(name=<span class="string">&#x27;stack&#x27;</span>, age=<span class="number">36</span>, gender=<span class="string">&#x27;male&#x27;</span>),</span><br><span class="line">    Student(name=<span class="string">&#x27;jeff&#x27;</span>, age=<span class="number">29</span>, gender=<span class="string">&#x27;male&#x27;</span>),</span><br><span class="line">    Student(name=<span class="string">&#x27;Monica&#x27;</span>, age=<span class="number">18</span>, gender=<span class="string">&#x27;female&#x27;</span>),</span><br><span class="line">]</span><br><span class="line">session.add_all(student_list)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<h2 id="查询-1"><a href="#查询-1" class="headerlink" title="查询"></a>查询</h2><ul>
<li>查询所有记录 <code>session().query(cls).all()</code></li>
<li>带条件的查询 <code>session().query(cls).filter(cls.attr == &quot;value&quot;)</code></li>
<li>多条件查询 <code>session().query(cls).filter(and_(条件1, 条件2))</code></li>
<li>单条记录的查询<ul>
<li><code>.first()</code> 调用多条记录中的第一条，若无记录，则返回 None</li>
<li><code>.one()</code> 结果集若为一条记录，则返回，否则抛出异常</li>
<li><code>.scalar()</code> 与 one()相似，区别在于 当结果集是 None 时，不抛出异常，返回 None</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若没有创建表 使用Base的metadata创建表</span></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给Session绑定engine</span></span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">session = Session()</span><br><span class="line"><span class="comment"># 查找所有学生信息</span></span><br><span class="line">students = session.query(Student).<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        <span class="string">f&#x27;id:<span class="subst">&#123;student.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;student.name&#125;</span>, age:<span class="subst">&#123;student.age&#125;</span>, gender:<span class="subst">&#123;student.gender&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找学生ID大于2 且 为女性的学生信息</span></span><br><span class="line">students = session.query(Student).<span class="built_in">filter</span>(and_(Student.<span class="built_in">id</span> &gt; <span class="number">2</span>, Student.gender == <span class="string">&#x27;female&#x27;</span>))</span><br><span class="line"><span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">    <span class="built_in">print</span>(student)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询学生ID大于3的第一条记录</span></span><br><span class="line">student = session.query(Student).<span class="built_in">filter</span>(Student.<span class="built_in">id</span> &gt; <span class="number">3</span>).first()</span><br><span class="line"><span class="built_in">print</span>(student)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用one()获取结果集为1条数据的记录，否则会抛出异常</span></span><br><span class="line">student = session.query(Student).<span class="built_in">filter</span>(Student.<span class="built_in">id</span> == <span class="number">3</span>).one()</span><br><span class="line"><span class="built_in">print</span>(student)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用scalar()获取的结果集为1条记录，若为空则返回None，若为多条记录抛出异常</span></span><br><span class="line">student = session.query(Student).<span class="built_in">filter</span>(Student.<span class="built_in">id</span> == <span class="number">9</span>).scalar()</span><br><span class="line"><span class="built_in">print</span>(student)</span><br></pre></td></tr></table></figure>

<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><ul>
<li>更新数据<ul>
<li>使用<code>obj.attr=&quot;value&quot;</code>，依据<code>one()</code>等 查询到某条数据后，直接通过对象属性的方式直接赋值</li>
<li><code>session().query(cls).filter(cls.id == &quot;value&quot;).update(&#123;cls.attr == &quot;value&quot; &#125;)</code></li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 给Session绑定engine</span></span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">session = Session()</span><br><span class="line"><span class="comment"># 学生id为4 的年龄+1</span></span><br><span class="line">student = session.query(Student).<span class="built_in">filter</span>(Student.<span class="built_in">id</span> == <span class="number">4</span>).one()</span><br><span class="line">student.age += <span class="number">1</span></span><br><span class="line">session.commit()</span><br><span class="line"></span><br><span class="line">student = session.query(Student).<span class="built_in">filter</span>(Student.<span class="built_in">id</span> == <span class="number">4</span>).update(&#123;Student.age: <span class="number">18</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(student)</span><br><span class="line">session.commit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有人年龄+1</span></span><br><span class="line">students = session.query(Student).update(&#123;Student.age: Student.age + <span class="number">1</span>&#125;)</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<h1 id="Mapped-映射"><a href="#Mapped-映射" class="headerlink" title="Mapped 映射"></a>Mapped 映射</h1><p>由 SQLAlchemy2.0 版本提供的新映射方式</p>
<ul>
<li><code>Mapped</code>、<code>mapped_column</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, Mapped, mapped_column</span><br><span class="line"></span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[<span class="built_in">int</span>] = mapped_column(primary_key=<span class="literal">True</span>)</span><br><span class="line">    name: Mapped[<span class="built_in">str</span>] = mapped_column(sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)</span><br><span class="line">    age: Mapped[<span class="built_in">int</span>] = mapped_column(nullable=<span class="literal">False</span>)</span><br><span class="line">    gender: Mapped[<span class="built_in">str</span>] = mapped_column(sqlalchemy.String(<span class="number">8</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>, age:<span class="subst">&#123;self.age&#125;</span>, gender:<span class="subst">&#123;self.gender&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">session = Session()</span><br><span class="line">students = session.query(Student).<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">    <span class="built_in">print</span>(student)</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Annotated</code>使 Mapped 更加便捷和得以复用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, Mapped, mapped_column</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> Annotated</span><br><span class="line"></span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">int_pk = Annotated[<span class="built_in">int</span>, mapped_column(primary_key=<span class="literal">True</span>)]</span><br><span class="line">str_name = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)]</span><br><span class="line">int_age = Annotated[<span class="built_in">int</span>, mapped_column(nullable=<span class="literal">False</span>)]</span><br><span class="line">str_gender = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">8</span>), nullable=<span class="literal">False</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    name: Mapped[str_name]</span><br><span class="line">    age: Mapped[int_age]</span><br><span class="line">    gender: Mapped[str_gender]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>, age:<span class="subst">&#123;self.age&#125;</span>, gender:<span class="subst">&#123;self.gender&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">session = Session()</span><br><span class="line">students = session.query(Student).<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">    <span class="built_in">print</span>(student)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>使用 sql 的<code>内置函数</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> func</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker, Mapped, mapped_column</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> Annotated</span><br><span class="line"></span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">int_pk = Annotated[<span class="built_in">int</span>, mapped_column(primary_key=<span class="literal">True</span>)]</span><br><span class="line">str_name = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)]</span><br><span class="line">int_age = Annotated[<span class="built_in">int</span>, mapped_column(nullable=<span class="literal">False</span>)]</span><br><span class="line">str_gender = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">8</span>), nullable=<span class="literal">False</span>)]</span><br><span class="line">timestamp_now = Annotated[datetime.datetime, mapped_column(nullable=<span class="literal">False</span>, server_default=func.now())]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    name: Mapped[str_name]</span><br><span class="line">    age: Mapped[int_age]</span><br><span class="line">    gender: Mapped[str_gender]</span><br><span class="line">    create_time: Mapped[timestamp_now]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>, age:<span class="subst">&#123;self.age&#125;</span>, gender:<span class="subst">&#123;self.gender&#125;</span>, create_time:<span class="subst">&#123;self.create_time&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="ORM-关联表"><a href="#ORM-关联表" class="headerlink" title="ORM 关联表"></a>ORM 关联表</h1><h2 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h2><ul>
<li><code>ForeignKey</code>定义外键</li>
<li><code>relationship</code>创建关系字段<ul>
<li><code>lazy=False</code>使得在查询关系字段的时候自动执行，提高查询效率（讲的时候可以试试给 T 和 F 运行效果看看）</li>
<li><code>backref=&quot;关系字段名&quot;</code> 给关系字段对应的类 指定关联关系字段 实现双向关联，虽然便捷 但是不推荐，因为很难直接从另一个类中看出有这个关系字段</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">engine = sqlalchemy.create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">int_pk = Annotated[<span class="built_in">int</span>, mapped_column(primary_key=<span class="literal">True</span>)]</span><br><span class="line">str_name = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)]</span><br><span class="line">int_age = Annotated[<span class="built_in">int</span>, mapped_column(nullable=<span class="literal">False</span>)]</span><br><span class="line">str_gender = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">8</span>), nullable=<span class="literal">False</span>)]</span><br><span class="line">class_id_fk = Annotated[<span class="built_in">int</span>, mapped_column(sqlalchemy.ForeignKey(<span class="string">&#x27;classes.id&#x27;</span>), nullable=<span class="literal">False</span>)]</span><br><span class="line">timestamp_now = Annotated[datetime.datetime, mapped_column(nullable=<span class="literal">False</span>, server_default=func.now())]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Class</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;classes&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    name: Mapped[str_name]</span><br><span class="line">    create_time: Mapped[timestamp_now]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>, create_time:<span class="subst">&#123;self.create_time&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    name: Mapped[str_name]</span><br><span class="line">    age: Mapped[int_age]</span><br><span class="line">    gender: Mapped[str_gender]</span><br><span class="line">    class_id: Mapped[class_id_fk]</span><br><span class="line">    create_time: Mapped[timestamp_now]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个关系字段，这并不是一个数据库字段</span></span><br><span class="line">    classes: Mapped[Class] = relationship(lazy=<span class="literal">False</span>, backref=<span class="string">&quot;students&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>, age:<span class="subst">&#123;self.age&#125;</span>, gender:<span class="subst">&#123;self.gender&#125;</span>, class_id:<span class="subst">&#123;self.class_id&#125;</span>, create_time:<span class="subst">&#123;self.create_time&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 插入操作</span></span><br><span class="line"><span class="comment"># 班级对象</span></span><br><span class="line">class_python = Class(name=<span class="string">&quot;Python&quot;</span>)</span><br><span class="line"><span class="comment"># 学生对象 插入的时候没有使用class_id, 直接插入了一个classes关系对象</span></span><br><span class="line">student = Student(name=<span class="string">&quot;zachary&quot;</span>, age=<span class="number">18</span>, gender=<span class="string">&quot;male&quot;</span>, classes=class_python)</span><br><span class="line"><span class="comment"># 在添加数据的时候发现Class表中 还没有python班级，依据关系字段，会自动执行insert语句，因此不需要给class表插入数据</span></span><br><span class="line">session.add(student)</span><br><span class="line">session.commit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询操作</span></span><br><span class="line">student = session.query(Student).<span class="built_in">filter</span>(Student.gender == <span class="string">&quot;female&quot;</span>).first()</span><br><span class="line"><span class="built_in">print</span>(student)</span><br><span class="line"><span class="comment"># 如果是lazy=True 则会再查询一次，否则一次就查询出结果</span></span><br><span class="line"><span class="built_in">print</span>(student.classes)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过backref实现双向关联</span></span><br><span class="line">classes = session.query(Class).<span class="built_in">filter</span>(Class.name == <span class="string">&quot;Python&quot;</span>).one()</span><br><span class="line"><span class="built_in">print</span>(classes)</span><br><span class="line"><span class="built_in">print</span>(classes.students)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<pre><code>- `back_populates=&quot;关联的关系字段名&quot;` 建议使用该方法进行关联关系的双向映射
</code></pre>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> func</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> declarative_base, mapped_column, Mapped, sessionmaker, relationship</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> Annotated</span><br><span class="line"></span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">int_pk = Annotated[<span class="built_in">int</span>, mapped_column(primary_key=<span class="literal">True</span>)]</span><br><span class="line">str_name = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)]</span><br><span class="line">int_age = Annotated[<span class="built_in">int</span>, mapped_column(nullable=<span class="literal">False</span>)]</span><br><span class="line">str_gender = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">8</span>), nullable=<span class="literal">False</span>)]</span><br><span class="line">class_id_fk = Annotated[<span class="built_in">int</span>, mapped_column(sqlalchemy.ForeignKey(<span class="string">&#x27;classes.id&#x27;</span>), nullable=<span class="literal">False</span>)]</span><br><span class="line">timestamp_now = Annotated[datetime.datetime, mapped_column(nullable=<span class="literal">False</span>, server_default=func.now())]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Class</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;classes&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    name: Mapped[str_name]</span><br><span class="line">    create_time: Mapped[timestamp_now]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个关系字段</span></span><br><span class="line">    students: Mapped[<span class="type">List</span>[<span class="string">&quot;Student&quot;</span>]] = relationship(lazy=<span class="literal">False</span>, back_populates=<span class="string">&quot;classes&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>, create_time:<span class="subst">&#123;self.create_time&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    name: Mapped[str_name]</span><br><span class="line">    age: Mapped[int_age]</span><br><span class="line">    gender: Mapped[str_gender]</span><br><span class="line">    class_id: Mapped[class_id_fk]</span><br><span class="line">    create_time: Mapped[timestamp_now]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个关系字段，这并不是一个数据库字段</span></span><br><span class="line">    classes: Mapped[Class] = relationship(lazy=<span class="literal">False</span>, back_populates=<span class="string">&quot;students&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>, age:<span class="subst">&#123;self.age&#125;</span>, gender:<span class="subst">&#123;self.gender&#125;</span>, class_id:<span class="subst">&#123;self.class_id&#125;</span>, create_time:<span class="subst">&#123;self.create_time&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过back_populates实现双向关联</span></span><br><span class="line">student = session.query(Student).<span class="built_in">filter</span>(Student.gender == <span class="string">&quot;female&quot;</span>).first()</span><br><span class="line"><span class="built_in">print</span>(student)</span><br><span class="line"><span class="built_in">print</span>(student.classes)</span><br><span class="line"></span><br><span class="line">classes = session.query(Class).<span class="built_in">filter</span>(Class.name == <span class="string">&quot;Python&quot;</span>).one()</span><br><span class="line"><span class="built_in">print</span>(classes)</span><br><span class="line"><span class="built_in">print</span>(classes.students)</span><br></pre></td></tr></table></figure>

<h2 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h2><p><img src="https://cdn.nlark.com/yuque/0/2024/jpeg/38881094/1705590114712-60305c94-2c22-4da3-bd1c-da3ec5c4618f.jpeg" alt="画板"></p>
<p>在用户登录注册的业务中，用户可以分为很多角色，同时用户可能拥有多重角色身份，这就需要使用多对多的关联</p>
<p>在这样的多对多关系中，通常需要一张<code>中间表</code>，因此在实现的时候首先需要定义这张中间表，同时这张中间表不是使用 class 进行的定义，而是使用<code>方法定义</code>的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">engine = create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">relation_table = Table(</span><br><span class="line">    <span class="string">&#x27;user_role&#x27;</span>, Base.Metadata,</span><br><span class="line">    Column(<span class="string">&#x27;user_id&#x27;</span>, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>), primary_key=<span class="literal">True</span>),</span><br><span class="line">    Column(<span class="string">&#x27;role_id&#x27;</span>, ForeignKey(<span class="string">&#x27;roles.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>创建 role 表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Table, create_engine, Column, ForeignKey</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> declarative_base, mapped_column, Mapped</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> Annotated</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">int_pk = Annotated[<span class="built_in">int</span>, mapped_column(primary_key=<span class="literal">True</span>)]</span><br><span class="line">str_name = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)]</span><br><span class="line"></span><br><span class="line">relation_table = Table(</span><br><span class="line">    <span class="string">&#x27;user_role&#x27;</span>, Base.Metadata,</span><br><span class="line">    Column(<span class="string">&#x27;user_id&#x27;</span>, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>), primary_key=<span class="literal">True</span>),</span><br><span class="line">    Column(<span class="string">&#x27;role_id&#x27;</span>, ForeignKey(<span class="string">&#x27;roles.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;roles&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    name: Mapped[str_name]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p>之后创建 user 表，需要创建单向关联字段</p>
<ul>
<li>使用 relationship()中的<code>secondary=&quot;中间表&quot;</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Table, create_engine, Column, ForeignKey</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> declarative_base, mapped_column, Mapped, relationship</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> Annotated</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">int_pk = Annotated[<span class="built_in">int</span>, mapped_column(primary_key=<span class="literal">True</span>)]</span><br><span class="line">str_unique_name = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)]</span><br><span class="line">str_pwd = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">64</span>), nullable=<span class="literal">False</span>)]</span><br><span class="line"></span><br><span class="line">relation_table = Table(</span><br><span class="line">    <span class="string">&#x27;user_role&#x27;</span>, Base.Metadata,</span><br><span class="line">    Column(<span class="string">&#x27;user_id&#x27;</span>, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>), primary_key=<span class="literal">True</span>),</span><br><span class="line">    Column(<span class="string">&#x27;role_id&#x27;</span>, ForeignKey(<span class="string">&#x27;roles.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;roles&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    role_name: Mapped[str_unique_name]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    account: Mapped[str_unique_name]</span><br><span class="line">    password: Mapped[str_pwd]</span><br><span class="line"></span><br><span class="line">    roles: Mapped[<span class="type">List</span>[<span class="string">&quot;Role&quot;</span>]] = relationship(lazy=<span class="literal">False</span>, secondary=relation_table)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">Base.Metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br></pre></td></tr></table></figure>

<p>尝试插入一些数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加数据</span></span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line">role_1 = Role(role_name=<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">role_2 = Role(role_name=<span class="string">&quot;user&quot;</span>)</span><br><span class="line">role_3 = Role(role_name=<span class="string">&quot;guest&quot;</span>)</span><br><span class="line"></span><br><span class="line">adminUser = User(account=<span class="string">&quot;Curry&quot;</span>, password=<span class="string">&quot;1234&quot;</span>)</span><br><span class="line">adminUser.roles.add(role_1)</span><br><span class="line">adminUser.roles.add(role_2)</span><br><span class="line"></span><br><span class="line">normalUser = User(account=<span class="string">&quot;Jordan&quot;</span>, password=<span class="string">&quot;1234&quot;</span>)</span><br><span class="line">normalUser.roles.add(role_2)</span><br><span class="line"></span><br><span class="line">guestUser = User(account=<span class="string">&quot;Harden&quot;</span>, password=<span class="string">&quot;1234&quot;</span>)</span><br><span class="line">guestUser.roles.add(role_3)</span><br><span class="line"></span><br><span class="line">session.add_all([adminUser, normalUser, guestUser])</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<p>查询一下数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user_data = session.query(User).<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> user_data:</span><br><span class="line">    <span class="built_in">print</span>(item)</span><br><span class="line">    <span class="built_in">print</span>(item.roles)</span><br></pre></td></tr></table></figure>

<p>至此 单向的关联关系是没问题的，照例实现一下从 role 关联至 user</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">Set</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Table, create_engine, Column, ForeignKey</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> declarative_base, mapped_column, Mapped, relationship, sessionmaker</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> Annotated</span><br><span class="line"></span><br><span class="line">engine = create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">int_pk = Annotated[<span class="built_in">int</span>, mapped_column(primary_key=<span class="literal">True</span>)]</span><br><span class="line">str_unique_name = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)]</span><br><span class="line">str_pwd = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">64</span>), nullable=<span class="literal">False</span>)]</span><br><span class="line"></span><br><span class="line">relation_table = Table(</span><br><span class="line">    <span class="string">&#x27;user_role&#x27;</span>, Base.metadata,</span><br><span class="line">    Column(<span class="string">&#x27;user_id&#x27;</span>, ForeignKey(<span class="string">&#x27;users.id&#x27;</span>), primary_key=<span class="literal">True</span>),</span><br><span class="line">    Column(<span class="string">&#x27;role_id&#x27;</span>, ForeignKey(<span class="string">&#x27;roles.id&#x27;</span>), primary_key=<span class="literal">True</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Role</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;roles&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    role_name: Mapped[str_unique_name]</span><br><span class="line"></span><br><span class="line">    users: Mapped[<span class="type">Set</span>[<span class="string">&quot;User&quot;</span>]] = relationship(lazy=<span class="literal">False</span>, secondary=relation_table, back_populates=<span class="string">&quot;roles&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, role_name:<span class="subst">&#123;self.role_name&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;users&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    account: Mapped[str_unique_name]</span><br><span class="line">    password: Mapped[str_pwd]</span><br><span class="line"></span><br><span class="line">    roles: Mapped[<span class="type">Set</span>[<span class="string">&quot;Role&quot;</span>]] = relationship(lazy=<span class="literal">False</span>, secondary=relation_table, back_populates=<span class="string">&quot;users&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, account:<span class="subst">&#123;self.account&#125;</span>, password:<span class="subst">&#123;self.password&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加数据</span></span><br><span class="line">session = Session()</span><br><span class="line"></span><br><span class="line">user_data = session.query(User).<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> user_data:</span><br><span class="line">    <span class="built_in">print</span>(item)</span><br><span class="line">    <span class="built_in">print</span>(item.roles)</span><br><span class="line"></span><br><span class="line">role_data = session.query(Role).<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> role_data:</span><br><span class="line">    <span class="built_in">print</span>(item)</span><br><span class="line">    <span class="built_in">print</span>(item.users)</span><br></pre></td></tr></table></figure>

<h2 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h2><p><img src="https://cdn.nlark.com/yuque/0/2024/jpeg/38881094/1705596862996-d23d4895-d3cd-4e3b-a889-cc994ecec750.jpeg" alt="画板"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># Author: Zachary</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> ForeignKey</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> declarative_base, Mapped, mapped_column, relationship, sessionmaker</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> Annotated</span><br><span class="line"></span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">int_pk = Annotated[<span class="built_in">int</span>, mapped_column(primary_key=<span class="literal">True</span>)]</span><br><span class="line">str_name = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">False</span>, nullable=<span class="literal">False</span>)]</span><br><span class="line">int_age = Annotated[<span class="built_in">int</span>, mapped_column(sqlalchemy.SmallInteger, nullable=<span class="literal">False</span>)]</span><br><span class="line">str_gender = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">8</span>), nullable=<span class="literal">False</span>)]</span><br><span class="line">date_exp_license = Annotated[</span><br><span class="line">    datetime.datetime, mapped_column(sqlalchemy.Date, default=datetime.datetime.now() + datetime.timedelta(days=<span class="number">365</span>))]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Driver</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;drivers&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    name: Mapped[str_name]</span><br><span class="line">    age: Mapped[int_age]</span><br><span class="line">    gender: Mapped[str_gender]</span><br><span class="line">    license_id: Mapped[<span class="built_in">str</span>] = mapped_column(ForeignKey(<span class="string">&#x27;licenses.id&#x27;</span>), nullable=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    license = relationship(<span class="string">&quot;License&quot;</span>, lazy=<span class="literal">False</span>, back_populates=<span class="string">&quot;driver&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>, age:<span class="subst">&#123;self.age&#125;</span>, gender:<span class="subst">&#123;self.gender&#125;</span>, license_id:<span class="subst">&#123;self.license_id&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">License</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;licenses&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    l_class: Mapped[str_name]</span><br><span class="line">    expiration_date: Mapped[date_exp_license]</span><br><span class="line"></span><br><span class="line">    driver = relationship(<span class="string">&quot;Driver&quot;</span>, lazy=<span class="literal">False</span>, back_populates=<span class="string">&quot;license&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, l_class:<span class="subst">&#123;self.l_class&#125;</span>, expiration_date:<span class="subst">&#123;self.expiration_date&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br></pre></td></tr></table></figure>

<p>尝试插入数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">license_1 = License(l_class=<span class="string">&quot;A&quot;</span>)</span><br><span class="line">license_2 = License(l_class=<span class="string">&quot;B&quot;</span>)</span><br><span class="line">license_3 = License(l_class=<span class="string">&quot;A&quot;</span>)</span><br><span class="line"></span><br><span class="line">driver_1 = Driver(name=<span class="string">&quot;Tom&quot;</span>, age=<span class="number">18</span>, gender=<span class="string">&quot;male&quot;</span>, license=license_1)</span><br><span class="line">driver_2 = Driver(name=<span class="string">&quot;Jerry&quot;</span>, age=<span class="number">20</span>, gender=<span class="string">&quot;female&quot;</span>, license=license_2)</span><br><span class="line">driver_3 = Driver(name=<span class="string">&quot;Jack&quot;</span>, age=<span class="number">22</span>, gender=<span class="string">&quot;male&quot;</span>, license=license_3)</span><br><span class="line"></span><br><span class="line">session.add_all([driver_1, driver_2, driver_3])</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<p>查询数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">license_1 = session.query(License).<span class="built_in">filter</span>(License.l_class == <span class="string">&quot;A&quot;</span>).<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> license_1:</span><br><span class="line">    <span class="built_in">print</span>(item)</span><br><span class="line">    <span class="built_in">print</span>(item.driver)</span><br><span class="line"></span><br><span class="line">driver = session.query(Driver).<span class="built_in">all</span>()</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> driver:</span><br><span class="line">    <span class="built_in">print</span>(item)</span><br><span class="line">    <span class="built_in">print</span>(item.license)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=============================&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>更新数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># driver id为3 的license_id 清空</span></span><br><span class="line">session.query(Driver).<span class="built_in">filter</span>(Driver.<span class="built_in">id</span> == <span class="number">3</span>).update(&#123;Driver.license_id: <span class="literal">None</span>&#125;)</span><br><span class="line">session.commit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新赋给driver id=3的license_id</span></span><br><span class="line">license_item = session.query(License).<span class="built_in">filter</span>(License.<span class="built_in">id</span> == <span class="number">3</span>).first()</span><br><span class="line">driver = session.query(Driver).<span class="built_in">filter</span>(Driver.<span class="built_in">id</span> == <span class="number">3</span>).first()</span><br><span class="line"><span class="keyword">if</span> license_item <span class="keyword">and</span> driver:</span><br><span class="line">    driver.license = license_item</span><br><span class="line">    session.commit()</span><br></pre></td></tr></table></figure>

<h1 id="ORM-操作"><a href="#ORM-操作" class="headerlink" title="ORM 操作"></a>ORM 操作</h1><h2 id="查询-2"><a href="#查询-2" class="headerlink" title="查询"></a>查询</h2><p>这里仍旧以一对多为例，沿用之前的学生 班级表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> <span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sqlalchemy</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> func</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> declarative_base, mapped_column, Mapped, sessionmaker, relationship</span><br><span class="line"><span class="keyword">from</span> typing_extensions <span class="keyword">import</span> Annotated</span><br><span class="line"></span><br><span class="line">engine = sqlalchemy.create_engine(<span class="string">&#x27;mysql://root:980226@localhost:3306/testSql?charset=utf8&#x27;</span>, echo=<span class="literal">True</span>)</span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line">int_pk = Annotated[<span class="built_in">int</span>, mapped_column(primary_key=<span class="literal">True</span>)]</span><br><span class="line">str_name = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">64</span>), unique=<span class="literal">True</span>, nullable=<span class="literal">False</span>)]</span><br><span class="line">int_age = Annotated[<span class="built_in">int</span>, mapped_column(nullable=<span class="literal">False</span>)]</span><br><span class="line">str_gender = Annotated[<span class="built_in">str</span>, mapped_column(sqlalchemy.String(<span class="number">8</span>), nullable=<span class="literal">False</span>)]</span><br><span class="line">class_id_fk = Annotated[<span class="built_in">int</span>, mapped_column(sqlalchemy.ForeignKey(<span class="string">&#x27;classes.id&#x27;</span>), nullable=<span class="literal">False</span>)]</span><br><span class="line">timestamp_now = Annotated[datetime.datetime, mapped_column(nullable=<span class="literal">False</span>, server_default=func.now())]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Class</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;classes&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    name: Mapped[str_name]</span><br><span class="line">    create_time: Mapped[timestamp_now]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个关系字段</span></span><br><span class="line">    students: Mapped[<span class="type">List</span>[<span class="string">&quot;Student&quot;</span>]] = relationship(back_populates=<span class="string">&quot;classes&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>, create_time:<span class="subst">&#123;self.create_time&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">Base</span>):</span><br><span class="line">    __tablename__ = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">    <span class="built_in">id</span>: Mapped[int_pk]</span><br><span class="line">    name: Mapped[str_name]</span><br><span class="line">    age: Mapped[int_age]</span><br><span class="line">    gender: Mapped[str_gender]</span><br><span class="line">    class_id: Mapped[class_id_fk]</span><br><span class="line">    create_time: Mapped[timestamp_now]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个关系字段，这并不是一个数据库字段</span></span><br><span class="line">    classes: Mapped[Class] = relationship(back_populates=<span class="string">&quot;students&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__repr__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;id:<span class="subst">&#123;self.<span class="built_in">id</span>&#125;</span>, name:<span class="subst">&#123;self.name&#125;</span>, age:<span class="subst">&#123;self.age&#125;</span>, gender:<span class="subst">&#123;self.gender&#125;</span>, class_id:<span class="subst">&#123;self.class_id&#125;</span>, create_time:<span class="subst">&#123;self.create_time&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Base.metadata.create_all(engine)</span><br><span class="line">Session = sessionmaker(bind=engine)</span><br><span class="line">session = Session()</span><br></pre></td></tr></table></figure>

<ul>
<li>查询的一些实例</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询所有学生信息，以姓名排序</span></span><br><span class="line">query = select(Student).order_by(Student.name)</span><br><span class="line">result = session.execute(query)</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> result:</span><br><span class="line">    <span class="built_in">print</span>(item)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询一个表中的某几个字段 id name</span></span><br><span class="line">query = select(Student.<span class="built_in">id</span>, Student.name).select_from(Student)</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用join函数做联合查询 默认是inner join</span></span><br><span class="line">query = select(Student,Class).join(Student.classes)</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line">query = select(Class, Student).join(Student.classes)</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询多个表中的某几个字段 stu.name cls.name</span></span><br><span class="line">query = select(Student.name, Class.name).join_from(Student, Class)</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用outer join函数做联合查询</span></span><br><span class="line">query = select(Student, Class).outerjoin(Class.students)</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line">query = select(Student, Class).select_from(outerjoin(Class, Student))</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line">query = select(Student, Class).outerjoin(Student.classes)</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line">query = select(Student, Class).select_from(outerjoin(Student, Class))</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用join函数实现outer join</span></span><br><span class="line">query = select(Student, Class).join(Student.classes, isouter=<span class="literal">True</span>)</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line">query = select(Class, Student).join(Student.classes, isouter=<span class="literal">True</span>)</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line"><span class="comment"># where 条件查询</span></span><br><span class="line">query = select(Student).where(Student.age &gt; <span class="number">18</span>, Student.gender == <span class="string">&#x27;male&#x27;</span>)</span><br><span class="line">execute_query(query)</span><br><span class="line">query = select(Student).where(and_(Student.age &gt; <span class="number">18</span>, Student.gender == <span class="string">&#x27;male&#x27;</span>))</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line">obj_stu = session.get(Student, <span class="number">1</span>)  <span class="comment"># 可以看看这个源码</span></span><br><span class="line">query = select(Student).where(Student.name == obj_stu.name)</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line">query = select(Student).where(Student.age != obj_stu.age)</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br><span class="line">query = select(Class).where(Class.students.contains(obj_stu))</span><br><span class="line">execute_query(query)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="插入-1"><a href="#插入-1" class="headerlink" title="插入"></a>插入</h2><ul>
<li><code>insert()</code>函数插入</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用insert()实现插入</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 给classes插入数据</span></span><br><span class="line">cls_1 = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Golang&quot;</span>&#125;</span><br><span class="line">cls_2 = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;C++&quot;</span>&#125;</span><br><span class="line">cls_list = [cls_1, cls_2]</span><br><span class="line">session.execute(insert(Class).values(cls_list))</span><br><span class="line">session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 给students插入数据</span></span><br><span class="line">student_1 = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Tom&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">18</span>, <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;male&quot;</span>, <span class="string">&quot;class_id&quot;</span>: select(Class.<span class="built_in">id</span>).where(Class.name == <span class="string">&quot;Golang&quot;</span>)&#125;</span><br><span class="line">student_2 = &#123;<span class="string">&quot;name&quot;</span>: <span class="string">&quot;Rose&quot;</span>, <span class="string">&quot;age&quot;</span>: <span class="number">20</span>, <span class="string">&quot;gender&quot;</span>: <span class="string">&quot;female&quot;</span>, <span class="string">&quot;class_id&quot;</span>: select(Class.<span class="built_in">id</span>).where(Class.name == <span class="string">&quot;C++&quot;</span>)&#125;</span><br><span class="line">student_list = [student_1, student_2]</span><br><span class="line">session.execute(insert(Student).values(student_list))</span><br><span class="line">session.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="更新-1"><a href="#更新-1" class="headerlink" title="更新"></a>更新</h2><ul>
<li><code>update()</code>函数更新</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用update()实现更新</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># id为3的学生想转到Golang班 id为4的学生想转到C++班</span></span><br><span class="line">update_1 = &#123;<span class="string">&quot;id&quot;</span>: <span class="number">3</span>, <span class="string">&quot;class_id&quot;</span>: session.execute(select(Class).where(Class.name == <span class="string">&quot;Golang&quot;</span>)).scalar_one().<span class="built_in">id</span>&#125;</span><br><span class="line">update_2 = &#123;<span class="string">&quot;id&quot;</span>: <span class="number">4</span>, <span class="string">&quot;class_id&quot;</span>: session.execute(select(Class).where(Class.name == <span class="string">&quot;C++&quot;</span>)).scalar_one().<span class="built_in">id</span>&#125;</span><br><span class="line">update_list = [update_1, update_2]</span><br><span class="line">session.execute(update(Student), update_list)</span><br><span class="line">session.commit()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><ul>
<li><code>delete()</code>函数删除</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 delete() 实现删除</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除id在8, 9, 10 的学生</span></span><br><span class="line">session.execute(delete(Student).where(Student.<span class="built_in">id</span>.in_([<span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>])))</span><br><span class="line">session.commit()</span><br></pre></td></tr></table></figure>

<h1 id="Session-与事务"><a href="#Session-与事务" class="headerlink" title="Session 与事务"></a>Session 与事务</h1><ul>
<li>Session 默认启用事务</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Session(engine) <span class="keyword">as</span> session: <span class="comment"># 事务的开始</span></span><br><span class="line">    ...</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在session.commit()之前发生任何异常，都会rollback</span></span><br><span class="line"><span class="comment"># 若无异常，提交后会关闭session</span></span><br></pre></td></tr></table></figure>

<ul>
<li>自动提交事务</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> Session(engine) <span class="keyword">as</span> session:</span><br><span class="line">    <span class="keyword">with</span> session.begin():</span><br><span class="line">        ...</span><br><span class="line">    	<span class="comment"># 到这块无异常，正常自动提交</span></span><br><span class="line"><span class="comment"># 自动关闭session</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Session(engine) <span class="keyword">as</span> session, session.begin():</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># 到这块无异常，正常自动提交</span></span><br><span class="line"><span class="comment"># 自动关闭session</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>更新: 2024-02-21 20:01:12<br>原文: <a target="_blank" rel="noopener" href="https://www.yuque.com/zacharyblock/cx2om6/uigosxw6s0n5b7k8">https://www.yuque.com/zacharyblock/cx2om6/uigosxw6s0n5b7k8</a></p>
</blockquote>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Zachary Block</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://blockzachary.github.io/blog/2691588494/">https://blockzachary.github.io/blog/2691588494/</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2019 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Python/"># Python</a>
                    
                        <a href="/tags/MySQL/"># MySQL</a>
                    
                        <a href="/tags/SQLAlchemy/"># SQLAlchemy</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/blog/4042161217/">Python - 单元测试</a>
            
            
            <a class="next" rel="next" href="/blog/2601309225/">Python - 异步IO</a>
            
        </section>


    </article>
</div>

<script src="/js/clipboard.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var codeBlocks = document.querySelectorAll('article .code pre');

        codeBlocks.forEach(function (codeBlock) {
            var copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.innerText = 'Copy';

            // Check if the code block is in the article content
            if (codeBlock.closest('article')) {
                codeBlock.parentNode.style.position = 'relative';
                codeBlock.parentNode.appendChild(copyButton); // 将按钮添加到 codeBlock 的父节点内

                var isCopying = false;

                copyButton.addEventListener('click', function () {
                    if (!isCopying) {
                        var codeText = codeBlock.innerText;
                        navigator.clipboard.writeText(codeText).then(function () {
                            copyButton.innerText = 'Copied!';
                            isCopying = true;
                            setTimeout(function () {
                                copyButton.innerText = 'Copy';
                                isCopying = false;
                            }, 1500);
                        }).catch(function (err) {
                            console.error('Copy failed', err);
                        });
                    }
                });
            }
        });
    });
</script>

<style>
    .copy-button {
        position: absolute;
        top: 0;
        right: 0;
        background-color: #2d96bd;
        color: #fff;
        border: none;
        border-radius: 10%;
        padding: 5px 10px;
        cursor: pointer;
    }
</style>
            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Zachary Block | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>

    <!-- Chic/layout.ejs -->
    <div id="u-search">
        <div class="modal">
            <div class="modal-header">
                <div class="container">
                    <form id="u-search-modal-form" class="u-search-modal-form">
                        <button type="submit" class="form-submit-btn">
                            <img src="/" class="search-btn-img" />
                        </button>
                        <input placeholder="搜索文章。。。" class="form-input" id="modal-form-input">
                    </form>
                    <a class="modal-close">x</a>
                </div>
                <div class="search-loading">
                    <div class="search-loading-bar"></div>
                </div>
            </div>
            <div class="modal-body">
                <!-- ul 格式如下 -->
                <!-- <ul class="modal-results">
                    <li class="result-item">
                        <a class="result-item-detail">
                            <span class="title">页面配置</span>
                            <span class="content">
                                content
                            </span>
                        </a>
                    </li>
                </ul> -->
            </div>
        </div>
        <div class="modal-overlay"></div>
    </div>
</body>

</html>